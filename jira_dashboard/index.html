
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/favicon.ico">

    <title>Jira Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href="/bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles -->
    <style>
    body {
      padding-top: 60px;
    }
    
    </style>
    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="/bower_components/jquery/dist/jquery.js"></script>
    <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    
    <!-- Charting JavaScript -->
    <script src='/bower_components/colorbrewer/colorbrewer.js' type='text/javascript'></script>
    <script src='/bower_components/d3/d3.js' type='text/javascript'></script>
    <script src='/bower_components/crossfilter2/crossfilter.js' type='text/javascript'></script>
    <script src='/bower_components/dc.js/dc.js' type='text/javascript'></script>
    <link href='/bower_components/dc.js/dc.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/datatables/media/js/jquery.dataTables.js' type='text/javascript'></script>
    <script src='/bower_components/datatables/media/js/dataTables.bootstrap.js' type='text/javascript'></script>
    <link href='/bower_components/datatables/media/css/dataTables.bootstrap.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/cubism/cubism.v1.js' type='text/javascript'></script>
    
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Jira Dashboard</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container" role="main">

      <div class="row">
        <div class="rol-sm-12">
          <h3 id="main-issue-info"></h3>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Status</h3>
            </div>
            <div class="panel-body">
              <div id="chart-status"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Assignee</h3>
            </div>
            <div class="panel-body">
              <div id="chart-assignee"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Priority</h3>
            </div>
            <div class="panel-body">
              <div id="chart-priority"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">CVIS Version</h3>
            </div>
            <div class="panel-body">
              <div id="chart-cvis"></div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Component</h3>
            </div>
            <div class="panel-body">
              <div id="chart-component"></div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Counts</h3>
            </div>
            <div class="panel-body">
              <h3>Issues: <span id="chart-count-issues"><span class="filter-count"></span> <small>of <span class="total-count"></span></small></span></h3>
              <h3>Time: <span id="chart-count-worked"></span> <small>/ <span id="chart-count-complete"></span></small></h3>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-12">
          <table class="table table-bordered table-hover" id="data-table">
            <thead>
              <tr>
                <th>Issue Id</th>
                <th>Status</th>
                <th>Summary</th>
                <th>Progress</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>

    </div><!-- /.container -->

    <script>
    try{

var facts = crossfilter();

var chartStatus = dc.pieChart("#chart-status");
    chartPriority = dc.pieChart("#chart-priority"),
    chartCVIS = dc.pieChart("#chart-cvis"),
    chartComponent = dc.pieChart("#chart-component"),
    chartCountIssues = dc.dataCount("#chart-count-issues"),
    chartCountComplete = dc.numberDisplay("#chart-count-complete"),
    chartCountWorked = dc.numberDisplay("#chart-count-worked"),
    chartAssignee = dc.pieChart("#chart-assignee");

var statusDim = facts.dimension(function(d) { return d.fields.status.name; }),
    priorityDim = facts.dimension(function(d) { return d.fields.priority.name; }),
    keyDim = facts.dimension(function(d) { return d.key; }),
    // TODO add other CVIS versions
    cvisDim = facts.dimension(function(d) { return d.fields.labels.filter(function(l) { return this.indexOf(l) >= 0;}, ["B2A", "B2B"]); }, true),
    componentDim = facts.dimension(function(d) { return d.fields.labels.filter(function(l) { return this.indexOf(l) >= 0;}, ["SDU", "CMFD"]); }, true),
    assigneeDim = facts.dimension(function(d) { return d.fields.assignee ? d.fields.assignee.key : "Unassigned"; });

chartCountIssues
  .dimension(facts)
  .group(facts.groupAll());

chartCountWorked
  .valueAccessor(function(d) { return d; })
  .group(facts.groupAll().reduceSum(function(d) { 
    
    var worklog = -1;
    if (d.fields.worklog && d.fields.worklog.worklogs) {
      worklog = 0;
      d.fields.worklog.worklogs.forEach(function(w) {
        worklog += w.timeSpentSeconds;
      });
    }
    
    if (d.fields.timetracking && d.fields.timetracking.timeSpentSeconds) {
      if (worklog == -1) {
        return d.fields.timetracking.timeSpentSeconds;
      }
      
      if (worklog != d.fields.timetracking.timeSpentSeconds) {
        alert(d.key + ' time spent = ' + d.fields.timetracking.timeSpentSeconds + ' worklog = ' + worklog);
        
        if (worklog > d.fields.timetracking.timeSpentSeconds) {
          return worklog;
        }
        return d.fields.timetracking.timeSpentSeconds;
      }
      
      return worklog;
    } else if (worklog > 0) {
      return worklog;
    }
    
    return 0;
  }));
  
chartCountComplete
  .valueAccessor(function(d) { return d; })
  .group(facts.groupAll().reduceSum(function(d) { 
    if (d.fields.timetracking && d.fields.timetracking.originalEstimateSeconds) {
      return d.fields.timetracking.originalEstimateSeconds; 
    }
    return 0;
  }));

chartStatus
  .innerRadius(30)
  .dimension(statusDim)
  .group(statusDim.group().reduceCount());
  
chartPriority
  .innerRadius(30)
  .dimension(priorityDim)
  .group(priorityDim.group().reduceCount());

chartCVIS
  .innerRadius(30)
  .dimension(cvisDim)
  .group(cvisDim.group().reduceCount());

chartComponent
  .innerRadius(30)
  .dimension(componentDim)
  .group(componentDim.group().reduceCount());

chartAssignee
  .innerRadius(30)
  .dimension(assigneeDim)
  .group(assigneeDim.group().reduceCount());

dc.renderAll();

d3.json('/data/SH2-50.json', function(err,json) {
  console.log(err,json);
  d3.select('#main-issue-info').html(json.key + '&nbsp;<small>'+json.fields.description+'</small>');
  
  for(var i = 0; i < json.fields.subtasks.length; i++) {
    var s = json.fields.subtasks[i];
    
    d3.json('/data/'+s.key+'.json', function(err,json) {
      if (err) { return; }
      
      //console.log(json);
      facts.add([json]);
      
      dc.redrawAll();
    });
  }
});

} catch (e) {
  console.log("ERROR",e);
  alert(e.message);
}
    </script>
  </body>
</html>
