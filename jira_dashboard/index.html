
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/favicon.ico">

    <title>Jira Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href="/bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles -->
    <style>
    body {
      padding-top: 60px;
    }
    
    </style>
    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="/bower_components/jquery/dist/jquery.js"></script>
    <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    
    <!-- Charting JavaScript -->
    <script src='/bower_components/colorbrewer/colorbrewer.js' type='text/javascript'></script>
    <script src='/bower_components/d3/d3.js' type='text/javascript'></script>
    <script src='/bower_components/crossfilter2/crossfilter.js' type='text/javascript'></script>
    <script src='/bower_components/dc.js/dc.js' type='text/javascript'></script>
    <link href='/bower_components/dc.js/dc.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/datatables/media/js/jquery.dataTables.js' type='text/javascript'></script>
    <script src='/bower_components/datatables/media/js/dataTables.bootstrap.js' type='text/javascript'></script>
    <link href='/bower_components/datatables/media/css/dataTables.bootstrap.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/cubism/cubism.v1.js' type='text/javascript'></script>
    
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Jira Dashboard</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container" role="main">

      <div class="row">
        <div class="rol-sm-12">
          <h3 id="main-issue-info"></h3>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Status <small>Count</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-status"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Assignee <small>Count</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-assignee"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Priority <small>Count</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-priority"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">CVIS Version <small>Count</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-cvis-component"></div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">ECP <small>Count</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-ecp"></div>
            </div>
          </div>
        </div>
        
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Counts</h3>
            </div>
            <div class="panel-body">
              <h3>Issues: <span id="chart-count-issues"></span> <small>of <span id="chart-count-issues-total"></span></small></h3>
              <h3>Worked: <span id="chart-count-worked"></span></h3>
              <h3>ETC: <span id="chart-count-complete"></span></h3>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-12">
          <table class="table table-bordered table-hover" id="data-table">
            <thead>
              <tr>
                <th>Issue Id</th>
                <th>Status</th>
                <th>Summary</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>

    </div><!-- /.container -->

    <script>
    try{
      
function formatSeconds(seconds) {
  var sec = 1;
  var sec_min = sec * 60;
  var sec_hour = sec_min * 60;
  var sec_day = sec_hour * 7.5;
  var sec_week = sec_day * 5;
  
  var weeks = Math.floor(seconds / sec_week);
  var days = Math.floor((seconds % sec_week) / sec_day);
  var hours = Math.floor(((seconds % sec_week) % sec_day) / sec_hour);
  var mins = Math.floor((((seconds % sec_week) % sec_day) % sec_hour) / sec_min);
  return (weeks ? weeks + "w " : "") +
         (days ? days + "d " : "") +
         (hours ? hours + "h " : "") +
         (mins ? mins + "m " : "");
}

function reduceCount(group) {
  function add(p, v, nf) {
    if (!p.has(v.key)) {
      p.set(v.key, 0);
    }
    
    p.set(v.key, p.get(v.key)+1);
    return p;
  }

  function rem(p, v, nf) {
    p.set(v.key, p.get(v.key)-1);
    if (p.get(v.key) <= 0) {
      p.remove(v.key);
    }
    return p;
  }

  function init() {
    return d3.map()
  }
  
  return group.reduce(add,rem,init);
}

function refreshDataTable() {
  dc.events.trigger(function () {
  
    var issues = d3.map();
    facts.allFiltered().forEach(function(d) {
      if (!issues.has(d.key)) {
        issues.set(d.key, d._orig);
      }
    });
  
    dataTable.api()
      .clear()
      .rows.add(issues.values())
      .draw();
  });
}

var now = new Date();
var facts = crossfilter();

var dataTable = $("#data-table").dataTable({
  "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
  "footerCallback": function ( row, data, start, end, display ) {
    var api = this.api(), data ;
  },
  "order": [[0, 'desc']],
  "dom": 'T<"clear-l"l><"clear-l"i><"clear-r"f><"clear-r"p>t',
  "tableTools": {
    "sSwfPath": "copy_csv_xls_pdf.swf"
  },
  columnDefs: [
    {
      targets: 0,
      data: function(d) { return '<a href="">' +d.key+ '</a>'; }
    },
    {
      targets: 1,
      data: function(d) { return d.fields.status.name; }
    },
    {
      targets: 2,
      data: function(d) { return d.fields.summary; }
    }
  ]
});

var chartStatus = dc.pieChart("#chart-status");
var chartAssignee = dc.pieChart("#chart-assignee");
var chartPriority = dc.pieChart("#chart-priority");
var chartCountIssues = dc.numberDisplay("#chart-count-issues");
var chartCountIssuesTotal = dc.numberDisplay("#chart-count-issues-total");
//var chartCountWorked = dc.numberDisplay("#chart-count-worked");
//var chartCountComplete = dc.numberDisplay("#chart-count-complete");

for (var i = 0; i < dc.chartRegistry.list().length; i++) {
  var chartI = dc.chartRegistry.list()[i];
  chartI.on("filtered", refreshDataTable);
}

var statusDim = facts.dimension(function(d) { return d.status; });
var priorityDim = facts.dimension(function(d) { return d.priority; });
var keyDim = facts.dimension(function(d) { return d.key; });
var  assigneeDim = facts.dimension(function(d) { return d.assigned; });

chartCountIssues
  .group(reduceCount(facts.groupAll()))
  .valueAccessor(function(d) { return d.size(); })
  .formatNumber(d3.format('.0f'));
  
chartCountIssuesTotal
  .group(keyDim.group())
  .data(function(d) { return d.all().length; })
  .valueAccessor(function(d) { return d.size(); })
  .formatNumber(d3.format('.0f'));

chartStatus
  .innerRadius(30)
  .dimension(statusDim)
  .group(reduceCount(statusDim.group()))
  .valueAccessor(function(d) { return d.value.size(); });

chartAssignee
  .innerRadius(30)
  .dimension(assigneeDim)
  .group(reduceCount(assigneeDim.group()))
  .valueAccessor(function(d) { return d.value.size(); });

chartPriority
  .innerRadius(30)
  .dimension(priorityDim)
  .group(reduceCount(priorityDim.group()))
  .valueAccessor(function(d) { return d.value.size(); });


dc.renderAll();

d3.json('/data/SH2-50.json', function(err,json) {
  console.log(err,json);
  d3.select('#main-issue-info').html(json.key + '&nbsp;<small>'+json.fields.description+'</small>');
  
  for(var i = 0; i < json.fields.subtasks.length; i++) {
    var s = json.fields.subtasks[i];
    
    d3.json('/data/'+s.key+'.json', function(err,json) {
      if (err) { return; }
      
      // flatten issue info with worklog
      if (json.fields.worklog && json.fields.worklog.worklogs && json.fields.worklog.worklogs.length > 0) {
        json.fields.worklog.worklogs.forEach(function(w) {
          var f = {
            _orig: json,
            key: json.key,
            summary: json.fields.summary,
            status: json.fields.status.name, 
            priority: json.fields.priority.name,
            assigned: json.fields.assignee ? json.fields.assignee.key : "Unassigned",
            
            timeSpent: w.timeSpent,
            timeSpentSeconds: w.timeSpentSeconds,
            timeStarted: w.started,
            timeAuthor: w.author.key
          };
          facts.add([f]);
        });
      } else {
        var f = {
          _orig: json,
          key: json.key,
          summary: json.fields.summary,
          status: json.fields.status.name,
          priority: json.fields.priority.name,
          assigned: json.fields.assignee ? json.fields.assignee.key : "Unassigned"
        };
        facts.add([f]);
      }
      
      refreshDataTable();
      dc.redrawAll();
    });
  }
});

} catch (e) {
  console.log("ERROR",e);
  alert(e.message);
}
    </script>
  </body>
</html>
