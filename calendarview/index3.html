<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <title>Spending Data</title>
  <script src='/colorbrewer.js' type='text/javascript'></script>
  <script src='/d3.js' type='text/javascript'></script>
  <script src='/crossfilter.js' type='text/javascript'></script>
  <script src='/dc.js' type='text/javascript'></script>
  <link href='/dc.css' rel='stylesheet' type='text/css'>
  <script src='/mytreeChart.js' type='text/javascript'></script>
  <style type="text/css"></style>
  <style>
    div.row p {
      display: inline;
    }
    p.big {
      width: 300px;
      position: absolute;
      text-align: center;
      vertical-align: middle;
      font-size: 50px;
    }
    
    path.link {
      fill: none;
      stroke: #ccc;
      stroke-width: 0.5px;
    }
    
    g.node {
      cursor: pointer;
    }
    
    g.node circle {
      stroke-width: 1px;
      fill-opacity: 0.2;
    }
    
    g.node circle.selected {
      fill-opacity: 0.9;
    }
  </style>
</head>
<body>
<div class='row'>
  <p id='data-count'></p>
  <p id='filters'></p>
</div>
<div class='row'>
  <p id="category-pie"></p>
  <p id="subcategory-pie"></p>
  <p class="big" id="total-spend"></p>
</div>
<div class="row">
  <p id="year-row"></p>
  <p id="month-row"></p>
  <p id="day-row"></p>
</div>
<div class="row">
  <p id="week-row"></p>
  <p id="my-tree"></p>
</div>
<table id="data-table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Amount</th>
      <th>Note</th>
    </tr>
  </thead>
</table>
<script type="text/javascript">

var facts = crossfilter();

var dollarFormat = d3.format("$,.4r");

var totalSpend = dc.numberDisplay("#total-spend"),
    dataTable = dc.dataTable("#data-table"),
    catPie = dc.pieChart("#category-pie"),
    subcatPie = dc.pieChart("#subcategory-pie"),
    yearRow = dc.rowChart("#year-row"),
    monthRow = dc.rowChart("#month-row"),
    dayRow = dc.rowChart("#day-row"),
    weekBar = dc.barChart("#week-row"),
    myTree = dc.mytreeChart("#my-tree");

var tf = d3.time.format('%A %b %e %H:%M'),
    df = d3.time.format('%w.%a'),
    mf = d3.time.format('%m.%b'),
    hf = d3.time.format('%H'),
    wf = d3.time.format('%W'),
    yf = d3.time.format('%Y'),
    tableFormat = d3.time.format('%Y-%m');

var filterTracker = {
  filters: {},
  redraw: function() {
    var data = d3.entries(filterTracker.filters).filter(function(d) { return d.value; });
    var p = d3.select("#filters").selectAll('p').data(data);
    p.exit().remove();
    p.enter().append('p');
    p.html(function(d) { return '<b>' + d.key + '</b> : ' + d.value; });
  },
  notify : function(name) {
    return function(chart, filter) {
      filterTracker.filters[name] = chart.filterPrinter()(chart.filters());
      filterTracker.redraw();
    }
  }
};

dc.dataCount('#data-count')
  .dimension(facts)
  .group(facts.groupAll())
  .html({
    some: '%filter-count/%total-count',
    all: 'All'
  });
  
totalSpend
  .group(facts.groupAll().reduceSum(function(d) { return d.amount; }))
  .valueAccessor(function(d) {
    return d;
  })
  .formatNumber(dollarFormat);
  
dataTable
  .width(960)
  .height(800)
  .order(d3.descending)
  .sortBy(function(d) { return d._date; })
  .group(function(d) { return tableFormat(d._date); })
  .dimension(facts.dimension(function (d) {
    return d.eid;
  }))
  .columns([
    function(d) { return tf(d._date); },
    function(d) { return '<b>'+ d.category + '</b> ' + d.subcategory; },
    function(d) { return d.amount; },
    function(d) { return d.note; }
  ]);
  
var catPieDim = facts.dimension(function(d) { return d.category; });

catPie
  .innerRadius(30)
  .title(function(d){return d.key + ": " + dollarFormat(d.value);})
  .dimension(catPieDim)
  .group(catPieDim.group().reduceSum(function(d) { return d.amount; }))
  .on('filtered', filterTracker.notify("Category"));
  
var subcatPieDim = facts.dimension(function(d) { return d.subcategory; });

subcatPie
  .innerRadius(30)
  .title(function(d){return d.key + ": " + dollarFormat(d.value);})
  .dimension(subcatPieDim)
  .group(subcatPieDim.group().reduceSum(function(d) { return d.amount; }))
  .on('filtered', filterTracker.notify("Sub Category"));
  
var yearDim = facts.dimension(function(d) { return yf(d._date); });

yearRow
  .elasticX(true)
  .dimension(yearDim)
  .group(yearDim.group().reduceSum(function(d) { return d.amount; }))
  .on('filtered', filterTracker.notify("Year"))
  .xAxis().ticks([5]).tickFormat(d3.format("$s"));
  
var monthDim = facts.dimension(function(d) { return mf(d._date); });

monthRow
  .elasticX(true)
  .label(function (d) { return d.key.split(".")[1]; })
  .dimension(monthDim)
  .group(monthDim.group().reduceSum(function(d) { return d.amount; }))
  .on('filtered', filterTracker.notify("Month"))
  .xAxis().ticks([5]).tickFormat(d3.format("$s"));
  
var dayDim = facts.dimension(function(d) { return df(d._date); });

dayRow
  .elasticX(true)
  .label(function (d) { return d.key.split(".")[1]; })
  .dimension(dayDim)
  .group(dayDim.group().reduceSum(function(d) { return d.amount; }))
  .on('filtered', filterTracker.notify("Day"))
  .xAxis().ticks([5]).tickFormat(d3.format("$s"));
  
var weekDim = facts.dimension(function(d) { return +wf(d._date); });

weekBar
  .width(500)
  .elasticY(true)
  .x(d3.scale.linear().domain([0,53]))
  .xAxisLabel("#Week")
  .dimension(weekDim)
  .group(weekDim.group().reduceSum(function(d) { return d.amount; }))
  .on('filtered', filterTracker.notify("Week"))
  .yAxis().ticks([5]).tickFormat(d3.format("$s"));
  
myTree.nest()
  .key(function(d) { return d.category; })
  .key(function(d) { return d.subcategory; })
  .rollup(function(values) { 
    console.log(values);
    
    var tot = 0;
    values.forEach(function(d) {
      tot += d.amount;
    });
    return tot;
  });

myTree.scale()
  .range([1,30]);

d3.csv("/transactions.csv", 
  function(d) { 
    d.datetime = (d.datetime*1000).toFixed(0)*1;
    d._date = new Date(d.datetime);
    d.amount = +d.amount;
    return d; 
  }, 
  function(error, csv) {
    facts.add(csv);
    
    myTree
      .data(csv)
      .scale()
        .domain(d3.extent(csv, function(d) { return d.amount; }));
    
    dc.renderAll();
  }
);
</script>    
</body>
</html>
