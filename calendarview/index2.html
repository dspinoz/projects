<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <title>dc.js Experiment</title>
  <script src='/colorbrewer.js' type='text/javascript'></script>
  <script src='/d3.js' type='text/javascript'></script>
  <script src='/crossfilter.js' type='text/javascript'></script>
  <script src='/dc.js' type='text/javascript'></script>
  <link href='/dc.css' rel='stylesheet' type='text/css'>
  <style type="text/css"></style>
  <style>
    body {
      font: 10px sans-serif;
      shape-rendering: auto;
    }
    #data-table tbody td.dc-table-column._3 {
      font-weight: bold;
    }
  </style>
</head>
<body>
<h3 id="test"></h3>
<h1>Transactions <span id="data-count">Showing <span class="filter-count"></span> of <span class="total-count"></span></span></h1>
<div id="credit-vs-debit"></div>
<div id="month"></div>
<div id="day"></div>
<div id="day-year"></div>
<table id="data-table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Credit</th>
      <th>Debit</th>
    </tr>
  </thead>
</table>
<script type="text/javascript">

var format = d3.time.format("%d/%m/%Y"),
    dayFormat = d3.time.format('%w.%a'),
    monthFormat = d3.time.format('%m.%b'),
    inputDateFormats = [d3.time.format("%-d/%m/%y"), 
                        d3.time.format("%-d/%m/%Y"), 
                        d3.time.format("%d/%m/%y"), 
                        d3.time.format("%d/%m/%Y")];

var dataTable = dc.dataTable("#data-table");
var creditVsDebitChart = dc.pieChart("#credit-vs-debit");
var dayChart = dc.rowChart("#day");
var monthChart = dc.rowChart("#month");
var dayYearChart = dc.barChart("#day-year");
     
var sumCreditDebit = function(d) {
  return d.Credit + d.Debit;
};

dc.myChart = function(parent, chartGroup) {
  var _chart = dc.baseChart({});
  var _size = 5;
  var _valueFormat = undefined;
  var _keyFormat = undefined;

  _chart.size = function(s) {
    if (!arguments.length) return _size;
    _size = s;
    return _chart;
  };
  
  _chart.keyFormat = function(f) {
    if (!arguments.length) return _keyFormat;
    _keyFormat = f;
    return _chart;
  };
  
  _chart.valueFormat = function(f) {
    if (!arguments.length) return _valueFormat;
    _valueFormat = f;
    return _chart;
  };
    
  _chart.doRender = function() {
    
    var data = [];
    
    _chart.group().all().forEach(function(d) {
      data.push(d);
    });
    
    if (data.length == 2) {
      data.push({key: 'Diff', value: data[0].value - data[1].value});
    }
    
    var span = _chart.selectAll("span").data(data);
    
    span.enter()
      .append('span');
      
    span.exit().remove();
    
    span.attr('class', function(d) {
        return d.key;
      })
      .text(function(d,i) {
        var val = d.value;
        if (_valueFormat) {
          val = _valueFormat(d.value);
        }
        
        var key = d.key;
        if (_keyFormat) {
          key = _keyFormat(d.key);
        }
        
        return key + ": " + val;
      });

    return _chart;
  };

  _chart.doRedraw = function(){
      return _chart.doRender();
  };

  return _chart.anchor(parent, chartGroup);
};

d3.csv("/data.csv", function(d) {
  var parsedDate = undefined;
  for(var i = 0; i < inputDateFormats.length; i++)
  {
    parsedDate = inputDateFormats[i].parse(d.Date);
    if (parsedDate != undefined) {
      break;
    }
  }
  
  if (parsedDate == undefined) {
    console.log('could not parse date', d.Date);
    return;
  }

  return {
    _date: parsedDate,
    Date: format(parsedDate),
    Debit: +d.Debit,
    Credit: +d.Credit,
    Description: d.Description
  };
}, 
function(error, csv) {

  var facts = crossfilter(csv);
  var all = facts.groupAll();

  var dateDimension = facts.dimension(function (d) {
    return d._date;
  });
  
  var dimCreditDebit = facts.dimension(function (d) {
    if (d.Credit > 0)
      return "Credit";
    else if (d.Debit > 0)
      return "Debit";
    else
      return "N/A";
  });
 
  var groupCreditDebit = dimCreditDebit.group().reduceSum(function(d) {
      if (d.Credit > 0)
        return d.Credit;
      else if (d.Debit > 0)
        return d.Debit;
      else
        return 0;
    });
    
  var dimDay = facts.dimension(function (d) {
    return dayFormat(d._date);
  });
  
  var dimMonth = facts.dimension(function (d) {
    return monthFormat(d._date);
  });
  
  var dimMonth2 = facts.dimension(function (d) {
    //slightly offset the dates to ensure that stack-ing 
    //does not draw over the top of one another
    //NOTE: only supports 999 max transactions per day!
  
    if (d.Credit > 0)
    {
      d._date.setHours(1);
      d._date.setMilliseconds(d._date.getMilliseconds()+1);
    }
    if (d.Debit > 0)
    {
      d._date.setHours(2);
      d._date.setMilliseconds(d._date.getMilliseconds()+1);
    }
  
    return d._date;
  });
  
  dc.dataCount("#data-count")
   .dimension(facts)
   .group(all);
   
  dc.myChart("#test")
    .dimension(dimCreditDebit)
    .group(groupCreditDebit)
    .valueFormat(d3.format("$0.2f"));
   
  dataTable.width(960).height(800)
    .dimension(dateDimension)
    .group(function(d) { return "Last Transactions"; })
    .size(10)
    .columns([
      function(d) { return d.Date; },
      function(d) { return d.Description; },
      function(d) { return d.Credit; },
      function(d) { return d.Debit; }
    ]);
  
  creditVsDebitChart.width(250)
    .height(220)
    .radius(100)
    .innerRadius(30)
    .colors(d3.scale.ordinal().domain(d3.range("Credit", "Debit", "N/A")).range(colorbrewer.Set1[3]))
    .dimension(dimCreditDebit)
    .title(function(d){return d.value;})
    .group(groupCreditDebit);
    
  dayChart.width(300)
    .height(220)
    .margins({top: 5, left: 10, right: 10, bottom: 20})
    .dimension(dimDay)
    .group(dimDay.group().reduceSum(sumCreditDebit))
    .gap(1)
    .colors(d3.scale.category10())
    .label(function (d){
       return d.key.split(".")[1];
    })
    .title(function(d){return d.value;})
    .elasticX(true)
    .xAxis().ticks(4);
    
  monthChart.width(300)
    .height(220)
    .margins({top: 5, left: 10, right: 10, bottom: 20})
    .dimension(dimMonth)
    .group(dimMonth.group().reduceSum(sumCreditDebit))
    .gap(1)
    .colors(d3.scale.category20())
    .label(function (d){
       return d.key.split(".")[1];
    })
    .title(function(d){return d.value;})
    .elasticX(true)
    .xAxis().ticks(4);
    
  dayYearChart.width(990) 
    .height(100)
    .margins({top: 0, right: 50, bottom: 20, left: 40})
    .dimension(dimMonth2)
    .colors(d3.scale.ordinal().domain(d3.range("Credit", "Debit", "N/A")).range(colorbrewer.Set1[3]))
    .group(dimMonth2.group().reduceSum(function (d) { if (d.Credit > 0) return d.Credit; return 0; }))
    .stack(dimMonth2.group().reduce(
      // show debits as negative bars
      function (p, v) {
        if (v.Debit > 0)
          return p - v.Debit;
        return p;
      },
      function (p, v) {
        if (v.Debit > 0)
          return p + v.Debit;
        return p;
      },
      function() {
        return 0;
      }
    ))
    .x(d3.time.scale().domain(d3.extent(csv, function(d) { return d._date; })));
    
    
  dc.renderAll();
  
  /*
  var p = d3.select('body').selectAll('p').data(csv);
  p.enter().append('p');
  p.exit().remove();
  p.text(function(d) { return JSON.stringify(d); });
  */
});
</script>    
</body>
</html>
