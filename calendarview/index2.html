<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <title>dc.js Experiment</title>
  <script src='/d3.js' type='text/javascript'></script>
  <script src='/crossfilter.js' type='text/javascript'></script>
  <script src='/dc.js' type='text/javascript'></script>
  <link href='/dc.css' rel='stylesheet' type='text/css'>
  <style type="text/css"></style>
  <style>
    body {
      font: 10px sans-serif;
      shape-rendering: auto;
    }
    #data-table tbody td.dc-table-column._3 {
      font-weight: bold;
    }
  </style>
</head>
<body>
<h1>Slice and Dice <span id="data-count">Showing <span class="filter-count"></span> of <span class="total-count"></span></span></h1>
<h3>Credit vs Debit</h3>
<div id="credit-vs-debit"></div>
<table id="data-table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Credit</th>
      <th>Debit</th>
    </tr>
  </thead>
</table>
<script type="text/javascript">

var format = d3.time.format("%d/%m/%Y"),
    inputDateFormats = [d3.time.format("%-d/%m/%y"), 
                        d3.time.format("%-d/%m/%Y"), 
                        d3.time.format("%d/%m/%y"), 
                        d3.time.format("%d/%m/%Y")];

var dataTable = dc.dataTable("#data-table");
var creditVsDebitChart = dc.pieChart("#credit-vs-debit");
                        
d3.csv("/data.csv", function(d) {
  var parsedDate = undefined;
  for(var i = 0; i < inputDateFormats.length; i++)
  {
    parsedDate = inputDateFormats[i].parse(d.Date);
    if (parsedDate != undefined) {
      break;
    }
  }
  
  if (parsedDate == undefined) {
    console.log('could not parse date', d.Date);
    return;
  }

  return {
    _date: parsedDate,
    Date: format(parsedDate),
    Debit: +d.Debit,
    Credit: +d.Credit,
    Description: d.Description
  };
}, 
function(error, csv) {

  var facts = crossfilter(csv);
  var all = facts.groupAll();

  var dateDimension = facts.dimension(function (d) {
    return d._date.getTime();
  });
  
  var dimCreditDebit = facts.dimension(function (d) {
    if (d.Credit > 0 && d.Credit > d.Debit)
      return "Credit";
    else if (d.Debit > 0 && d.Debit > d.Credit)
      return "Debit";
    else
      return "N/A";
  });
  
  
  dc.dataCount("#data-count")
   .dimension(facts)
   .group(all);
   
  dataTable.width(960).height(800)
    .dimension(dateDimension)
    .group(function(d) { return "Last Transactions"; })
    .size(10)
    .columns([
      function(d) { return d.Date; },
      function(d) { return d.Description; },
      function(d) { return d.Credit; },
      function(d) { return d.Debit; }
    ]);
  
  creditVsDebitChart.width(250)
    .height(220)
    .radius(100)
    .innerRadius(30)
    .dimension(dimCreditDebit)
    .title(function(d){return d.value;})
    .group(dimCreditDebit.group());
    
    
  dc.renderAll();

  
  var p = d3.select('body').selectAll('p').data(csv);
  p.enter().append('p');
  p.exit().remove();
  p.text(function(d) { return JSON.stringify(d); });
});
</script>    
</body>
</html>