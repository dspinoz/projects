<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <title>dc.js Experiment</title>
  <script src='/colorbrewer.js' type='text/javascript'></script>
  <script src='/d3.js' type='text/javascript'></script>
  <script src='/crossfilter.js' type='text/javascript'></script>
  <script src='/dc.js' type='text/javascript'></script>
  <link href='/dc.css' rel='stylesheet' type='text/css'>
  <style type="text/css"></style>
  <style>
    body {
      font: 10px sans-serif;
      shape-rendering: auto;
    }
    #data-table tbody td.dc-table-column._3 {
      font-weight: bold;
    }
  </style>
</head>
<body>
<h1>Transactions <span id="data-count">Showing <span class="filter-count"></span> of <span class="total-count"></span></span></h1>
<div id="credit-vs-debit"></div>
<div id="month"></div>
<div id="day"></div>
<table id="data-table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Credit</th>
      <th>Debit</th>
    </tr>
  </thead>
</table>
<script type="text/javascript">

var format = d3.time.format("%d/%m/%Y"),
    dayFormat = d3.time.format('%w.%a'),
    monthFormat = d3.time.format('%m.%b'),
    inputDateFormats = [d3.time.format("%-d/%m/%y"), 
                        d3.time.format("%-d/%m/%Y"), 
                        d3.time.format("%d/%m/%y"), 
                        d3.time.format("%d/%m/%Y")];

var dataTable = dc.dataTable("#data-table");
var creditVsDebitChart = dc.pieChart("#credit-vs-debit");
var dayChart = dc.rowChart("#day");
var monthChart = dc.rowChart("#month");
                        
d3.csv("/data.csv", function(d) {
  var parsedDate = undefined;
  for(var i = 0; i < inputDateFormats.length; i++)
  {
    parsedDate = inputDateFormats[i].parse(d.Date);
    if (parsedDate != undefined) {
      break;
    }
  }
  
  if (parsedDate == undefined) {
    console.log('could not parse date', d.Date);
    return;
  }

  return {
    _date: parsedDate,
    Date: format(parsedDate),
    Debit: +d.Debit,
    Credit: +d.Credit,
    Description: d.Description
  };
}, 
function(error, csv) {

  var facts = crossfilter(csv);
  var all = facts.groupAll();

  var dateDimension = facts.dimension(function (d) {
    return d._date.getTime();
  });
  
  var dimCreditDebit = facts.dimension(function (d) {
    if (d.Credit > 0 && d.Credit > d.Debit)
      return "Credit";
    else if (d.Debit > 0 && d.Debit > d.Credit)
      return "Debit";
    else
      return "N/A";
  });
  
  var dimDay = facts.dimension(function (d) {
    return dayFormat(d._date);
  });
  
  var dimMonth = facts.dimension(function (d) {
    return monthFormat(d._date);
  });
  
  
  dc.dataCount("#data-count")
   .dimension(facts)
   .group(all);
   
  dataTable.width(960).height(800)
    .dimension(dateDimension)
    .group(function(d) { return "Last Transactions"; })
    .size(10)
    .columns([
      function(d) { return d.Date; },
      function(d) { return d.Description; },
      function(d) { return d.Credit; },
      function(d) { return d.Debit; }
    ]);
  
  creditVsDebitChart.width(250)
    .height(220)
    .radius(100)
    .innerRadius(30)
    .colors(d3.scale.ordinal().domain(d3.range("Credit", "Debit", "N/A")).range(colorbrewer.Set1[3]))
    .dimension(dimCreditDebit)
    .title(function(d){return d.value;})
    .group(dimCreditDebit.group());
    
  dayChart.width(300)
    .height(220)
    .margins({top: 5, left: 10, right: 10, bottom: 20})
    .dimension(dimDay)
    .group(dimDay.group())
    .colors(d3.scale.category10())
    .label(function (d){
       return d.key.split(".")[1];
    })
    .title(function(d){return d.value;})
    .elasticX(true)
    .xAxis().ticks(4);
    
  monthChart.width(300)
    .height(220)
    .margins({top: 5, left: 10, right: 10, bottom: 20})
    .dimension(dimMonth)
    .group(dimMonth.group())
    .colors(d3.scale.category20())
    .label(function (d){
       return d.key.split(".")[1];
    })
    .title(function(d){return d.value;})
    .elasticX(true)
    .xAxis().ticks(4);
    
    
  dc.renderAll();

  
  var p = d3.select('body').selectAll('p').data(csv);
  p.enter().append('p');
  p.exit().remove();
  p.text(function(d) { return JSON.stringify(d); });
});
</script>    
</body>
</html>