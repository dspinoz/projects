
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/favicon.ico">

    <title>Garmin Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href="/bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles -->
    <style>
    body {
      padding-top: 60px;
    }
    
    
#comparison {
  margin: auto auto;
  width: 100%;
  position: relative;
}

.axis {
  font: 10px sans-serif;
  position: fixed;
  pointer-events: none;
  z-index: 2;
}

.axis text {
  -webkit-transition: fill-opacity 250ms linear;
}

.axis path {
  display: none;
}

.axis line {
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis.top {
  background-image: linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -o-linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -moz-linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -webkit-linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -ms-linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  top: 0px;
  padding: 0 0 24px 0;
}

.axis.bottom {
  background-image: linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -o-linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -moz-linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -webkit-linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -ms-linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  bottom: 0px;
  padding: 24px 0 0 0;
}

.horizon {
  border-bottom: solid 1px #000;
  overflow: hidden;
  position: relative;
}

:not(.horizon) + .horizon {
  border-top: solid 1px #000;
}

.horizon canvas {
  display: block;
}

.horizon .title,
.horizon .value {
  bottom: 0;
  line-height: 30px;
  margin: 0 6px;
  position: absolute;
  text-shadow: 0 1px 0 rgba(255,255,255,.5);
  white-space: nowrap;
}

.horizon .title {
  left: 0;
}

.horizon .value {
  right: 0;
}

.line {
  background: #000;
  z-index: 1;
  margin-left: 15px;
}

#step {
  position: fixed;
  bottom: 6px;
  z-index: 3;
}

@media all and (max-width: 1439px) {
  body { margin: 0px auto; }
  .axis { position: static; }
  .axis.top, .axis.bottom { padding: 0; }
}
    
    
    
    
    
    </style>
    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="/bower_components/jquery/dist/jquery.js"></script>
    <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    
    <!-- Charting JavaScript -->
    <script src='/bower_components/colorbrewer/colorbrewer.js' type='text/javascript'></script>
    <script src='/bower_components/d3/d3.js' type='text/javascript'></script>
    <script src='/bower_components/crossfilter2/crossfilter.js' type='text/javascript'></script>
    <script src='/bower_components/dc.js/dc.js' type='text/javascript'></script>
    <link href='/bower_components/dc.js/dc.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/datatables/media/js/jquery.dataTables.js' type='text/javascript'></script>
    <script src='/bower_components/datatables/media/js/dataTables.bootstrap.js' type='text/javascript'></script>
    <link href='/bower_components/datatables/media/css/dataTables.bootstrap.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/cubism/cubism.v1.js' type='text/javascript'></script>
    
    <script src='/tcx_parser.js' type='text/javascript'></script>
    
    <!--
    <script src='/mytreeChart.js' type='text/javascript'></script>
    <script src='/mycalendarChart.js' type='text/javascript'></script>
    <script src='/myDimensions.js' type='text/javascript'></script>
    -->
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Garmin Dashboard</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container" role="main">

      <div class="row">
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Laps</h3>
            </div>
            <div class="panel-body">
              <div id="chart-laps"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Heart Rate / Time</h3>
            </div>
            <div class="panel-body">
              <div id="chart-laps-time"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Distance / Time</h3>
            </div>
            <div class="panel-body">
              <div id="chart-distance-time"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-12">
          <table class="table table-bordered table-hover" id="data-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Lap</th>
                <th>Distance</th>
                <th>Heart Rate</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Altitude</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>

    </div><!-- /.container -->

    <script>
    
var facts = crossfilter();

function format_sec_to_time(sec_num) {
    
  var hours   = Math.floor(sec_num / 3600);
  var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
  var seconds = sec_num - (hours * 3600) - (minutes * 60);

  if (hours != 0 && hours   < 10) {hours   = "0"+hours+":";} else { hours = ""; }
  if (minutes < 10) {minutes = "0"+minutes;}
  if (seconds < 10) {seconds = "0"+seconds;}
  return hours + minutes+':'+seconds;
}

var dataTableOptions = {
  "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
  "footerCallback": function ( row, data, start, end, display ) {
    var api = this.api(), data ;
  },
  "order": [[0, 'desc']],
  "dom": 'T<"clear-l"l><"clear-l"i><"clear-r"f><"clear-r"p>t',
  "tableTools": {
    "sSwfPath": "copy_csv_xls_pdf.swf"
  },
  columnDefs: [
    {
      targets: 0,
      data: function(d) { return format_sec_to_time(d['Time Diff']); }
    },
    {
      targets: 1,
      data: function(d) { return d['Lap']; }
    },
    {
      targets: 2,
      data: function(d) { return d['Distance Diff']; }
    },
    {
      targets: 3,
      data: function(d) { return d['Heart Rate']; }
    },
    {
      targets: 4,
      data: function(d) { return d['Position Lat']; }
    },
    {
      targets: 5,
      data: function(d) { return d['Position Lon']; }
    },
    {
      targets: 6,
      data: function(d) { return d['Altitude']; }
    }
  ]
} ;


var dataTable = $("#data-table").dataTable(dataTableOptions);
var chartLaps = dc.pieChart("#chart-laps");
var chartLapsTime = dc.lineChart("#chart-laps-time");
var chartDistanceTime = dc.lineChart("#chart-distance-time");

function RefreshTable() {
  dc.events.trigger(function () {
    
    dataTable.api()
      .clear()
      .rows.add(facts.dimension(function (d) {
                  return d.eid;
                }).top(Infinity))
      .draw();
      
    chartLapsTimeXScale.domain(
      d3.extent(chartLapsTimeGroup.all(), 
        function(d) { return chartLapsTime.keyAccessor()(d); }));
    
    chartLapsTimeYScale.domain(
      d3.extent(chartLapsTimeGroup.all(), 
        function(d) { return chartLapsTime.valueAccessor()(d); })); 
      
    chartDistanceTimeXScale.domain(
      d3.extent(chartDistanceTimeGroup.all(), 
        function(d) { return chartDistanceTime.keyAccessor()(d); }));
    
    chartDistanceTimeYScale.domain(
      d3.extent(chartDistanceTimeGroup.all(), 
        function(d) { return chartDistanceTime.valueAccessor()(d); })); 
        
        
        
  });
}

for (var i = 0; i < dc.chartRegistry.list().length; i++) {
  var chartI = dc.chartRegistry.list()[i];
  chartI.on("filtered", RefreshTable);
}

var chartLapsDim = facts.dimension(function(d) { return d['Lap']; });

chartLaps
  .innerRadius(30)
  .title(function(d){return d['Lap'];})
  .dimension(chartLapsDim)
  .group(chartLapsDim.group().reduceCount());



var xslStylesheet;
var xsltProcessor = new XSLTProcessor();
var myDOM;

var xmlDoc;

// load the xslt file, example1.xsl
  var myXMLHTTPRequest = new XMLHttpRequest();
  myXMLHTTPRequest.open("GET", "tcx_to_csv.xsl", false);
  myXMLHTTPRequest.send(null);

  xslStylesheet = myXMLHTTPRequest.responseXML;
  xsltProcessor.importStylesheet(xslStylesheet);


  // load the xml file, example1.xml
  myXMLHTTPRequest = new XMLHttpRequest();
  myXMLHTTPRequest.open("GET", "tcx.xml", false);
  myXMLHTTPRequest.send(null);

  xmlDoc = myXMLHTTPRequest.responseXML;
  
  console.log('xml', xmlDoc);

  var fragment = xsltProcessor.transformToFragment(xmlDoc, document);

  //document.getElementById("example").innerHTML = "";

  myDOM = fragment;
  //document.getElementById("example").appendChild(fragment);

  var rows = fragment.textContent.split('\n');
  
  var header = rows.shift().split(',');
  
  // eg. 2011-09-07T02:44:10.000Z
  var timeParser = d3.time.format.iso;
  var firstTime = -1;
  
  var lastDistance = -1;
  
  var data = rows.map(function(d) {
    
    var cols = d.split(',');
    
    return cols.reduce(function(accum,val,i) {
      accum[i] = val;
      accum[header[i]] = val;
      
      if (i == 1 && header[i] == 'Time') {
        accum['Time Parsed'] = timeParser.parse(val);
        
        if (firstTime < 0) {
          firstTime = accum['Time Parsed'].getTime();
        }
        
        accum['Time Diff'] = (accum['Time Parsed'].getTime() - firstTime) / 1000;
      }
      
      if (i == 4 && header[i] == 'Heart Rate') {
        accum['Heart Rate'] = +val;
      }
      
      if (i == 5 && header[i] == 'Distance') {
        accum['Distance'] = +val;
        
        if (lastDistance < 0) {
          lastDistance = accum['Distance'];
        }
        
        accum['Distance Diff'] = accum['Distance'] - lastDistance;
        
        lastDistance = accum['Distance'];
      }
      
      return accum;
    }, {});
  });
  
  
  //d3.select('body').append('p').attr('class','error').text(JSON.stringify(data.shift()));

    console.log('data[0]', data[0]);

    facts.add(data);
    
    
function reduceAddAvg(attr) {
  return function(p,v) {
    ++p.count
    p.sum += v[attr];
    p.avg = p.sum/p.count;
    return p;
  };
}
function reduceRemoveAvg(attr) {
  return function(p,v) {
    --p.count
    p.sum -= v[attr];
    p.avg = p.count ? p.sum/p.count : 0;
    return p;
  };
}
function reduceInitAvg() {
  return {count:0, sum:0, avg:0};
}

//https://github.com/dc-js/dc.js/issues/667
function nonzero_min(chart) {
  dc.override(chart, 'yAxisMin', function () {
    var min = d3.min(chart.data(), function (layer) {
      return d3.min(
        layer.values.filter(function(p) { return p.y != 0; }), 
        function (p) {
          return p.y + p.y0;
        });
    });
    return dc.utils.subtract(min, chart.yAxisPadding());
  });
  
  return chart;
}    
    
    
var chartLapsTimeScale = d3.time.second;
var interval = 5;
var chartLapsTimeDim = facts.dimension(function(d) { return d['Time Diff']; });
var chartDistanceTimeDim = facts.dimension(function(d) { return d['Time Diff']; });
  
function date_to_interval(d) {
    var date = d['Time Parsed'];
    var subHalf = chartLapsTimeScale.offset(date, -1 * interval / 2);
    var addHalf = chartLapsTimeScale.offset(date, interval / 2);
    return chartLapsTimeScale.range(subHalf, addHalf, interval)[0];
};

var chartLapsTimeGroup = chartLapsTimeDim.group()//.reduceSum(function(d) { return d['Heart Rate']; });

  .reduce(reduceAddAvg('Heart Rate'), reduceRemoveAvg('Heart Rate'), reduceInitAvg);
  
  
var chartDistanceTimeGroup = chartDistanceTimeDim.group().reduceSum(function(d) { return d['Distance Diff']; });
  
function remove_empty_bins(chart, group) {
  return {
    all:function () {
      return group.all().filter(function(d) {
        return chart.valueAccessor()(d) != 0;
      });
    }
  };
}
chartLapsTimeGroup = remove_empty_bins(chartLapsTime, chartLapsTimeGroup);
chartDistanceTimeGroup = remove_empty_bins(chartDistanceTime, chartDistanceTimeGroup);

var chartLapsTimeXScale = d3.scale.linear()
    .domain(
      d3.extent(chartLapsTimeGroup.all(), 
        function(d) { return chartLapsTime.keyAccessor()(d); }));
    
var chartLapsTimeYScale = d3.scale.linear()
  .domain(
    d3.extent(chartLapsTimeGroup.all(), 
      function(d) { return chartLapsTime.valueAccessor()(d); })); 
    
nonzero_min(chartLapsTime)
  .keyAccessor(function(d) { return d.key; })
  .valueAccessor(function(d) { return d.value.avg; })
  .x(chartLapsTimeXScale)
  .elasticX(true)
  .y(chartLapsTimeYScale)
  .elasticY(true)
  .dimension(chartLapsTimeDim)
  .group(chartLapsTimeGroup)
  .xAxis().tickFormat(format_sec_to_time).ticks(7);
    
    
var chartDistanceTimeXScale = d3.scale.linear()
    .domain(
      d3.extent(chartDistanceTimeGroup.all(), 
        function(d) { return chartDistanceTime.keyAccessor()(d); }));
    
var chartDistanceTimeYScale = d3.scale.linear()
  .domain(
    d3.extent(chartDistanceTimeGroup.all(), 
      function(d) { return chartDistanceTime.valueAccessor()(d); })); 
    
nonzero_min(chartDistanceTime)
  .keyAccessor(function(d) { return d.key; })
  .valueAccessor(function(d) { return d.value; })
  .x(chartDistanceTimeXScale)
  .elasticX(true)
  .y(chartDistanceTimeYScale)
  .elasticY(true)
  .dimension(chartDistanceTimeDim)
  .group(chartDistanceTimeGroup)
  .xAxis().tickFormat(format_sec_to_time).ticks(7);
    
    console.log('renderall');
    
    RefreshTable();
    
    dc.renderAll();
    
    console.log('renderall done');
    







/*


d3.csv("/data.csv", 
  function(d) { 
    var d2 = {
      _orig: JSON.parse(JSON.stringify(d)),
      name: d.name,
      _tcx: tcx.read(d.name,undefined,d3),
      _valid: true
    };
    
    return d2;
  }, 
  function(error, csv) {
    
    if (error) {
      console.log(error);
      d3.select('body').append('p').attr('class','error').text(JSON.stringify(error));
      return;
    }
    
    
    // logging
    var p = d3.select('#activities').append('ul').selectAll('li').data(csv);

    p.enter().append('li');

    p.exit().remove();

    p.text(function(d) { return d.name; })
     .on('click', function(d) {
       
       d3.select('#activities').style('display','none');
       
       d3.select('#current').append('div').text(d.name);
       
     });
    
    
    //only put valid data though
    var data = [];
    csv.forEach(function(d) {
        
      if (!d._valid) {
        console.log('Invalid data', d._orig);
        return;
      }
        
      data.push(d);
    });
    
    facts.add(data);
    
    console.log('renderall');
    
    RefreshTable();
    
    dc.renderAll();
    
    console.log('renderall done');
    
  });

*/

    </script>
  </body>
</html>
