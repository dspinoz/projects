
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/favicon.ico">

    <title>Garmin Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href="/bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles -->
    <style>
    body {
      padding-top: 60px;
    }

    @media all and (max-width: 1439px) {
      body { margin: 0px auto; }
      .axis { position: static; }
      .axis.top, .axis.bottom { padding: 0; }
    }
    
    </style>
    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="/bower_components/jquery/dist/jquery.js"></script>
    <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    
    <!-- Charting JavaScript -->
    <script src='/bower_components/colorbrewer/colorbrewer.js' type='text/javascript'></script>
    <script src='/bower_components/d3/d3.js' type='text/javascript'></script>
    <script src='/bower_components/crossfilter2/crossfilter.js' type='text/javascript'></script>
    <script src='/bower_components/dc.js/dc.js' type='text/javascript'></script>
    <link href='/bower_components/dc.js/dc.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/datatables/media/js/jquery.dataTables.js' type='text/javascript'></script>
    <script src='/bower_components/datatables/media/js/dataTables.bootstrap.js' type='text/javascript'></script>
    <link href='/bower_components/datatables/media/css/dataTables.bootstrap.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/cubism/cubism.v1.js' type='text/javascript'></script>
    
    <script src='/utils.js' type='text/javascript'></script>
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Garmin Dashboard</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <div class="progress" style="margin-top:15px;">
            <div class="progress-bar progress-bar-success" style="width: 0%">
              <span class="sr-only">Complete</span>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container" role="main">

      <div class="row">
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Activity</h3>
            </div>
            <div class="panel-body">
              <div id="chart-activity"></div>
              <div id="chart-filename"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Lap <small>Distance / Time</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-lap-distance"></div>
              <div id="chart-lap-time"></div>
              <table class="table table-condensed" id="chart-stats-lap"></table>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Lap <small>Type</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-lap-type"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Stats</h3>
            </div>
            <div class="panel-body">
              <table class="table table-condensed">
                <tr><th>Points</th><td id="chart-stats-points"></td></tr>
                <tr><th>Distance</th><td id="chart-stats-distance"></td></tr>
                <tr><th>Elapsed Time</th><td id="chart-stats-time"></td></tr>
                <tr><th>Moving Time</th><td id="chart-stats-mtime"></td></tr>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Heart Rate / Time</h3>
            </div>
            <div class="panel-body">
              <div id="chart-hr-time"></div>
              <table class="table table-condensed" id="chart-stats-hr"></table>
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Speed <small>Distance / Time</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-speed-time"></div>
              <table class="table table-condensed" id="chart-stats-speed"></table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-12">
          <table class="table table-bordered table-hover" id="data-table">
            <thead>
              <tr>
                <th>File</th>
                <th>Activity</th>
                <th>Time</th>
                <th>Distance</th>
                <th>Speed</th>
                <th>Heart Rate</th>
                <th>Section</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>

    </div><!-- /.container -->

    <script>
try{

var timeParser = d3.time.format.iso;
var timeFormat = d3.time.format('%c');
var timeScale = d3.time.second;
var facts = crossfilter();

function FileMovingTimeDate(d) {
  this.f = d.File;
  this.m = d.TimeMoving;
  this.t = d.Time;
}
FileMovingTimeDate.prototype.valueOf = function() {
  return this.m;
};

var filenameDim = facts.dimension(function(d) { return d.File; });
var activityDim = facts.dimension(function(d) { return d.Activity; });
var lapDim = facts.dimension(function(d) { return d.Lap; });
var lapTypeDim = facts.dimension(function(d) { return d.LapType; });
var hrTimeDim = facts.dimension(function(d) { return new FileMovingTimeDate(d); });
var speedTimeDim = facts.dimension(function(d) { return [d.File, d.TimeMoving]; });
var movingTimeDim = facts.dimension(function(d) { return d.TimeMoving; });
  
var chartActivity = dc.pieChart("#chart-activity");
var chartFilename = dc.pieChart("#chart-filename");
var chartLapDistance = dc.pieChart("#chart-lap-distance");
var chartLapTime = dc.pieChart("#chart-lap-time");
var chartLapType = dc.pieChart("#chart-lap-type");
var chartPointsCount = dc.numberDisplay("#chart-stats-points");
var chartTotalDistance = dc.numberDisplay("#chart-stats-distance");
var chartTotalTime = dc.numberDisplay("#chart-stats-time");
var chartMovingTime = dc.numberDisplay("#chart-stats-mtime");
var chartHRTime = dc.lineChart("#chart-hr-time");
var chartSpeedTime = dc.seriesChart("#chart-speed-time");


var dataTable = $("#data-table").dataTable({
  "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
  "footerCallback": function ( row, data, start, end, display ) {
  },
  "order": [[0, 'desc']],
  "dom": 'T<"clear-l"l><"clear-l"i><"clear-r"f><"clear-r"p>t',
  "tableTools": {
    "sSwfPath": "copy_csv_xls_pdf.swf"
  },
  columnDefs: [
    {
      targets: 0,
      data: function(d) { return d.File + " " + timeFormat(d.Time) + " ["+ formatSeconds(d.TimeMoving/1000) +"] ("+formatSeconds(d.TimeElapsed/1000)+") "; }
//return JSON.stringify(d); }
    },
    {
      targets: 1,
      data: function(d) { return d.Activity; }
    },
    {
      targets: 2,
      data: function(d) { return d.TimePoint; }
    },
    {
      targets: 3,
      data: function(d) { return d.DistancePoint; }
    },
    {
      targets: 4,
      data: function(d) { return d3.round(d.SpeedMS,3) + "m/s " + d3.round(d.SpeedKH,3) + "km/h " + formatSeconds(d.PaceSK,false) + "m/km"; }
    },
    {
      targets: 5,
      data: function(d) { return d.HeartRate; }
    },
    {
      targets: 6,
      data: function(d) { return d.LapType; }
    }
  ]
});

for (var i = 0; i < dc.chartRegistry.list().length; i++) {
  var chartI = dc.chartRegistry.list()[i];
  chartI.on("filtered", refreshDataTable);
}

function refreshDataTable() {
  dc.events.trigger(function () {
    
    dataTable.api()
      .clear()
      .rows.add(facts.allFiltered())
      .draw();
      
      /*
    if (d3.extent(chartHRTimeGroup.all(), 
        function(d) { return chartHRTime.keyAccessor()(d); }).filter(function(d) { return d == undefined; }).length == 0 &&
        d3.extent(chartHRTimeGroup.all(), 
        function(d) { return chartHRTime.valueAccessor()(d); }).filter(function(d) { return d == undefined; }).length == 0 &&
        d3.extent(chartWeeksGroup.all(), function(d) { 
      return d3.min(d.value.entries(),function(e) { return e.value; }); }).filter(function(d) { return d == undefined; }).length == 0) {
      */
    chartHRTimeXScale.domain(
      d3.extent(chartHRTimeGroup.all(), 
        function(d) { return chartHRTime.keyAccessor()(d); }));
    
    console.log('chart hr time y', 
      chartHRTime.yAxisMin(),
      chartHRTimeGroup.all(), 
      d3.extent(chartHRTimeGroup.all(), 
          function(d) { return chartHRTime.valueAccessor()(d); })
    );
        
        
    console.log("HR DATA",chartHRTimeGroup.all(),chartWeeksGroup.all());
    chartHRTimeGroup.all().forEach(function(d,i) {
      console.log(i,d,formatSeconds(d.key,false),chartHRTime.valueAccessor()(d));
    });
    
    var bbb = [];
    chartWeeksGroup.all().forEach(function(d,i) {
      var a = [];
      d.value.entries().map(function(d) { return d.value; }).forEach(function(d) {
        d.forEach(function(d) {
          a.push(d);
        });
      });
      
      bbb.push(chartHRTime.valueAccessor()(a.reduce(function(t,d) {
          t.value.count++;
          t.value.total += d;
          t.value.avg = t.value.total/t.value.count;
          return t;
        }, {value: {count:0, total:0, avg:0}})));
      
      
      
      
    });
        
        
    var a = d3.extent(chartHRTimeGroup.all(), 
        function(d) { return chartHRTime.valueAccessor()(d); });
    var b = d3.extent(bbb);
        
        
    
    
      
        
    console.log('HR TIME',a,'HR WEEKS',b,d3.extent([a[0],a[1],b[0],b[1]]));
    chartHRTimeYScale.domain(d3.extent([a[0],a[1],b[0],b[1]]));
    //chartHRTime.y().domain([Math.min(a[0],b[0]), Math.max(a[1],b[1])]);
    //chartHRTime.y().domain(b);
        
        
        // calculate the average value for each series
        // converts the data like the internals to series chart
        //var nester = d3.nest().key(function(d,i) { if (i==0) console.log('nest data',d); return d.key.f; });

        //var nesting = nester.entries(chart.data());
        
        console.log('CHART HR', 'nest', chartHRTime.data());
    

  //}      
    chartHRTime.redraw();
        
    chartSpeedTimeXScale.domain(
      d3.extent(chartSpeedTimeGroup.all(), 
        function(d) { return chartSpeedTime.keyAccessor()(d); }));
    
    chartSpeedTimeYScale.domain(
      d3.extent(chartSpeedTimeGroup.all(), 
        function(d) { return chartSpeedTime.valueAccessor()(d); }));

  });
}

chartActivity
  .width(200)
  .innerRadius(20)
  .dimension(activityDim)
  .group(activityDim.group().reduceCount())
  .valueAccessor(function(d) { return d.value; });
  
chartFilename
  .width(200)
  .innerRadius(20)
  .dimension(filenameDim)
  .group(filenameDim.group().reduceCount())
  .valueAccessor(function(d) { return d.value; });
  
chartLapDistance
  .width(200)
  .innerRadius(20)
  .dimension(lapDim)
  .group(lapDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .valueAccessor(function(d) { return d.value; })
  .title(function(d) {
    return d.key + ": " + d3.round(d.value / 1000) + " km";
  })
  .on('renderlet', function(chart) {
    console.log('lap distance', chart.data(), chart.group().all());
  });
  
chartLapTime
  .width(200)
  .innerRadius(20)
  .dimension(lapDim)
  .group(lapDim.group().reduceSum(function(d) { return d.TimePoint; }))
  .valueAccessor(function(d) { return d.value; })
  .title(function(d) {
    return d.key + ": " + formatSeconds(d3.round(d.value / 1000));
  });

chartLapType
  .width(200)
  .innerRadius(20)
  .dimension(lapTypeDim)
  .group(lapTypeDim.group().reduceCount())
  .valueAccessor(function(d) { return d.value; });

chartPointsCount
  .group(facts.groupAll().reduce(function(p) {
      return p + 1;
    }, function(p) {
      return p - 1;
    }, function() {
      return 0;
    }))
  .formatNumber(d3.round)
  .valueAccessor(function(d) { return d; });
  
chartTotalDistance
  .group(facts.groupAll().reduceSum(function(d) { return d.DistancePoint; }))
  .formatNumber(function(d) {
    return d3.round(d / 1000,2) + " km";
  })
  .valueAccessor(function(d) { return d; });
  
chartTotalTime
  .group(facts.groupAll().reduceSum(function(d) { return d.TimePoint; }))
  .formatNumber(function(d) {
    return formatSeconds(d3.round(d / 1000));
  })
  .valueAccessor(function(d) { return d; });

chartMovingTime
  .group(facts.groupAll().reduceSum(function(d) { 


return d.LapType == "Stationary" ? 0 : d.TimePoint; }))
  .formatNumber(function(d) {
    return formatSeconds(d3.round(d / 1000));
  })
  .valueAccessor(function(d) { return d; });


//issue with multiple values on same key
function reduceWorklogOrig(group) {
  function kfn(d) {
    return d.File;
  }
  
  function vfn(d) {
    return d['HeartRate'];
  }
  
  function add(p, v, nf) {
    if (!p.has(kfn(v))) {
      p.set(kfn(v), 0);
    } else {
      console.log('WEEKS REDUCE EXISTS',kfn(v),v);
    }
    
    p.set(kfn(v), p.get(kfn(v))+vfn(v));
    return p;
  }
  
  function rem(p, v, nf) {
    p.set(kfn(v), p.get(kfn(v))-vfn(v));
    if (p.get(kfn(v)) <= 0) {
      p.remove(kfn(v));
    }
    return p;
  }
  
  function init() {
    return d3.map()
  }
  return group.reduce(add,rem,init);
}

function reduceWorklog(group) {
  function kfn(d) {
    return d.File;
  }
  
  function vfn(d) {
    return d['HeartRate'];
  }
  
  function add(p, v, nf) {
    if (!p.has(kfn(v))) {
      p.set(kfn(v), []);
    } else {
      console.log('WEEKS REDUCE EXISTS',kfn(v),v);
    }
    
    p.get(kfn(v)).push(vfn(v));
    //p.set(kfn(v), p.get(kfn(v))+vfn(v));
    return p;
  }
  
  function rem(p, v, nf) {
    
    var upd = [];
    var removed = false;
    
    p.get(kfn(v)).forEach(function(d) {
      if (!removed && d == vfn(v)) {
        removed = true;
      } else {
        upd.push(d);
      }
    });
    
    p.set(kfn(v), upd);
    
    if (upd.length == 0) {
      p.remove(kfn(v));
    }
    
    return p;
  }
  
  function init() {
    return d3.map()
  }
  return group.reduce(add,rem,init);
}

function chartWeeksGroupAccessor(index) {
  return function(d,i) {
//    if (d.key.getTime() == 0 || d.value.size() == 0) return 0;
    if (!d.value.has(index)) return undefined;
    
    var ret = {count:0, total: 0, avg:0};
    d.value.get(index).forEach(function(d) {
      ret.count++;
      ret.total+=d;
      ret.avg = ret.total/ret.count;
    });
//if (i==0) alert('weekvalueaccessor' + i+'  ' + JSON.stringify(d) + ' ret ' + JSON.stringify(ret) + ' out ' + (ret.avg*0.75));
    
    return ret.avg * 0.75;
  }
}

var chartWeeksGroup = reduceWorklog(movingTimeDim.group());

/*
chartHRTime  .stack(chartWeeksGroup, 
'activity_2562354543.tcx',
chartWeeksGroupAccessor(
'activity_2562354543.tcx'));
*/

/*
chartHRTime  .stack(chartWeeksGroup, 
0,
chartWeeksGroupAccessor(
0));
*/

var chartHRTimeGroup = remove_empty_bins(chartHRTime, 
movingTimeDim.group()
  .reduce(reduceAddAvg('HeartRate'), reduceRemoveAvg('HeartRate'), reduceInitAvg)
  );
  

var chartHRTimeXScale = d3.scale.linear()
    .domain(
      d3.extent(chartHRTimeGroup.all(), 
        function(d) { return chartHRTime.keyAccessor()(d); }));
    
var chartHRTimeYScale = d3.scale.linear()
  .domain(
    d3.extent(chartHRTimeGroup.all(), 
      function(d) { return chartHRTime.valueAccessor()(d); })); 
    

//TODO nonzero_min
chartHRTime
  .width(500)
  //.keyAccessor(function(d,i) {  return d.key.m; })
  .valueAccessor(function(d,i) { 
//if (i==0) alert('valueaccessor' + i+'  ' + JSON.stringify(d) + ' out' + d.value.avg);


return d.value.avg; })
  .x(chartHRTimeXScale)
  .elasticX(true)
  .y(chartHRTimeYScale)
  .yAxisLabel("aaa")
//TODO yaxis not rendered correctly on open
  .elasticY(true)
  .dimension(movingTimeDim)
  .group(chartHRTimeGroup, "Average")
  //.seriesAccessor(function(d) { return d.key.f; })
    .renderDataPoints(true)
    .renderArea(true)
    .legend(dc.legend().x(60).y(10).itemHeight(13).gap(5))
    //.brushOn(false)
    //.stack(chartHRTimeGroup, function(d) {  return d.key.f; })
//each stack per file
/*
.stack(chartWeeksGroup, 0, chartWeeksGroupAccessor(0))
.stack(chartWeeksGroup, 1, chartWeeksGroupAccessor(1))
.stack(chartWeeksGroup, 2, chartWeeksGroupAccessor(2))
.stack(chartWeeksGroup, 3, chartWeeksGroupAccessor(3))
*/
  .on('renderlet', function(chart) {
      console.log('CHART HR', 'y domain', chart.y().domain(), chartHRTime.y().domain());

        
        //TODO line not rendering on correct position of y axis
        var line = d3.svg.line()
            .x(function(d) { return d.x; })
            .y(function(d) { return d.y; })
            .interpolate('linear');
        
        var chartBody = chart.select('g.chart-body');
        
        
        var extras = d3.range(chart.y().range()[1], chart.y().range()[0], 10).map(function(d,i) {
          return {key: i, value: d};
        });
        
        //extras.push(average);
        
        //console.log("CHART HR",chart.y().domain()[1], chart.y().domain()[0], extras);
        
        var path = chartBody.selectAll('path.extra').data(extras);
        
        path.exit().remove();
        
        path.enter().append('path')
        .attr('class', 'extra')
        .attr('stroke', chart.getColor);
        
        path
        .attr('id', function(d,i) { return 'extra-line-'+i; })
        .attr('d', function(d) {
          var p1 = [chart.x().range()[0], chart.y()(d.value)];
          var p2 = [chart.x().range()[1], chart.y()(d.value)];
        
          return 'M' + p1[0] + ',' + p1[1] + 'L' + p2[0] + ','+p2[1]; 
        });
        
        // and perhaps you'd like to label it?
        var text = chartBody.selectAll('text.extra-label').data(extras);
        text.exit().remove();
        text.enter()
        .append('text')
        .attr('class', 'extra-label')
        .attr('text-anchor', 'middle')
        .append('textPath')
        .attr({
          class: 'extra-label',
          startOffset: '50%'
        });
          
        text.select('textPath.extra-label')
        .attr('xlink:href', function(d,i) { return '#extra-line-'+i; })
        .text(function(d) {
          return format_hr(d.value);
        });
    });

chartHRTime.yAxis()
  .tickFormat(function(d) { console.log('CHART HR Y TICK', d); return d; });

chartHRTime.xAxis()
    .tickFormat(function(d) {
      // format based on the first time value
      return formatSeconds(d/1000 - chartHRTimeXScale.domain()[0]/1000,false);
    })
    ;//.ticks(7);




var chartSpeedTimeGroup = remove_empty_bins(chartSpeedTime, speedTimeDim.group()
  .reduce(reduceAddAvg('SpeedMS'), reduceRemoveAvg('SpeedMS'), reduceInitAvg));
  
var chartSpeedTimeXScale = d3.scale.linear()
    .domain(
      d3.extent(chartSpeedTimeGroup.all(), 
        function(d) { return chartSpeedTime.keyAccessor()(d); }));
    
var chartSpeedTimeYScale = d3.scale.linear()
  .domain(
    d3.extent(chartSpeedTimeGroup.all(), 
      function(d) { return chartSpeedTime.valueAccessor()(d); })); 
    
chartSpeedTime
  .width(500)
  .chart(dc.lineChart)
  .keyAccessor(function(d,i) { return d.key[1]; })
  .valueAccessor(function(d) { return d.value.avg; })
  .x(chartSpeedTimeXScale)
  .elasticX(true)
  .y(chartSpeedTimeYScale)
  .elasticY(true)
  .dimension(speedTimeDim)
  .group(chartSpeedTimeGroup)
  .seriesAccessor(function(d) { return d.key[0]; })
  .on('renderlet', function(chart) {
        // calculate the average value for each series
        // converts the data like the internals to series chart
        var nester = d3.nest().key(chart.seriesAccessor());
        if (chart.seriesSort()) {
            nester.sortKeys(chart.seriesSort());
        }
        if (chart.valueSort()) {
            nester.sortValues(chart.valueSort());
        }
        var nesting = nester.entries(chart.data());
    
        var averages = nesting.map(function(series) {
          var count = 0;
          var total = 0;
          
          series.values.forEach(function(d) {
            total += chart.valueAccessor()(d);
            count++;
          });
          
          return {key: series.key, value: total/count};
        });
        
        var average = {key: 'Global', count: 0, total: 0, value: 0};
        chart.data().forEach(function(d) {
          average.total += chart.valueAccessor()(d);
          average.count++;
          average.value = average.total / average.count;
        });
    
        console.log('speed data',chart.data(),average,averages);
        
        {
          var rows = [average];
          averages.forEach(function(a) {
            rows.push(a);
          });
          
          var tr = d3.select('#chart-stats-speed').selectAll('tr.avg').data(rows);
          tr.exit().remove();
          tr.enter().append('tr').attr('class', 'avg');
          tr.html(function(d) {
            return '<tr><th>'+d.key+'</th><td>'+formatSeconds(1000 / d.value,false)+'</td></tr>';
          });
        }
        
        
        var line = d3.svg.line()
            .x(function(d) { return d.x; })
            .y(function(d) { return d.y; })
            .interpolate('linear');
        
        var chartBody = chart.select('g.chart-body');
        var path = chartBody.selectAll('path.extra').data([average]);
        
        path.exit().remove();
        
        path.enter().insert('path', ':first-child').attr({
            class: 'extra',
            id: 'extra-line'
        }).attr('stroke', chart.getColor);
        
        path.attr('d', function(d) {
          var p1 = [chart.x().range()[0], chart.y()(d.value)];
          var p2 = [chart.x().range()[1], chart.y()(d.value)];
        
          return 'M' + p1[0] + ',' + p1[1] + 'L' + p2[0] + ','+p2[1]; 
        });
        
        // and perhaps you'd like to label it?
        var text = chartBody.selectAll('text.extra-label').data([average]);
        text.exit().remove();
        text.enter()
        .insert('text',':last-child')
        .attr('class', 'extra-label')
        .attr('text-anchor', 'middle')
        .insert('textPath',':first-child')
        .attr({
          class: 'extra-label',
          'xlink:href': '#extra-line',
          startOffset: '50%'
        });
          
        text.select('textPath.extra-label').text(function(d) {
          return formatSeconds(1000 / d.value,false);
        });
    });
  
chartSpeedTime.xAxis()
    .tickFormat(function(d) {
      return formatSeconds(d/1000 - chartSpeedTimeXScale.domain()[0]/1000,false);
    });

chartSpeedTime.margins().left = 40;
chartSpeedTime.yAxis()
    .tickFormat(function(d) {
      var kmh = d * 3.6;
      var paceK = 1000 / d;
      return formatSeconds(paceK,false);
    });

var redraw_count = 0;
function redraw() {
  if (facts.size() > 0) {
    if (redraw_count == 0) {
      dc.renderAll();
    } else {
      dc.redrawAll();
    }
    refreshDataTable();
    redraw_count++;
  }
}

redraw();

d3.csv('/activities.csv', function(activities) {
  redraw();
  
  var total = activities.length;
  var complete = 0;
  
  activities.forEach(function(a,i) {
    
    // length represents the type of workout, in minutes
    var lenRegex = /^([0-9]+)\-([0-9]+)\-([0-9]+)$/g;
    var lenMatch = lenRegex.exec(a.Length);
    if (lenMatch != null) {
      var start = 0;
      var lenWarmup = +lenMatch[1]*60*1000;
      var lenWorkout = +lenMatch[2]*60*1000;
      var lenCooldown = +lenMatch[3]*60*1000;
      
      var warmupEnd = start + lenWarmup;
      var workoutEnd = warmupEnd + lenWorkout;
      var cooldownEnd = workoutEnd + lenCooldown;
      
      a.Length = {
        Warmup: [0, warmupEnd], 
        Workout: [warmupEnd, workoutEnd], 
        CoolDown: [workoutEnd,cooldownEnd]};
    } else if (/^[0-9]+$/) {
      a.Length = {Workout: [0,+a.Length*60*1000]};
    } else {
      console.log("Activity has invalid length " + a.Length,a);
    }
    
    //dynamic stacks based on activity filename
    chartHRTime.stack(chartWeeksGroup, a.File, chartWeeksGroupAccessor(a.File))
    
    d3.csv('/activities/'+a.File, function(d,i) {
      
      d.File = a.File;
      d.Lap = +d.Lap;
      d.Distance = +d.Distance;
      d.Time = timeParser.parse(d.Time);
      d.TimeInterval = dateToInterval(d, 'Time', timeScale, 1);
      d.HeartRate = +d['Heart Rate'];
      delete d['Heart Rate'];
      
      if (d.HeartRate > 200) {
        console.log('**MAX HR',d.HeartRate,d);
      }
      
      return d;
    }, function(data) {
      console.log('activity',a,data);
      
      d3.select('.progress-bar').classed('progress-bar-success', true).style('width', ((++complete/total)*100)+'%');
      
      var lengthKeys = d3.keys(a.Length);
      
      var elapsedTime = 0;
      var movingTime = 0;
      data.forEach(function(d,i,arr) {
        d.Activity = a.Name;
        d.ActivityLength = a.Length;
        d.DistancePoint = i == 0 ? d.Distance : d.Distance - data[i-1].Distance;
        d.TimePoint = i == 0 ? 1000 : d.Time - data[i-1].Time;

        elapsedTime += d.TimePoint;
        d.TimeElapsed = elapsedTime;

        //calc speed with rolling window across multiple data points. sometimes distance is recorded as 0 between points, artifically creating "faster" points
        var window = 5;
        var right = Math.min(i+window,arr.length-1);
        var left = Math.max(i-window,0);
        var first = arr[left];
        var last = arr[right];
        var t = last.Time - first.Time;
        var l = last.Distance - first.Distance;

        d.SpeedMS = (l/(t/1000));
        d.SpeedKH = d.SpeedMS * 3.6;
        d.PaceSK = 1000 / d.SpeedMS;
        d.PaceSM = 1609.344 / d.SpeedMS;
        
        if (d.SpeedKH < 1) {
          d.LapType = "Stationary";
          d.TimeMoving = movingTime;
        } else {
          movingTime += d.TimePoint;
          d.TimeMoving = movingTime;

        if (lengthKeys.length == 1) {
          d.LapType = lengthKeys[0];
        } else if (lengthKeys.length == 3) {
          lengthKeys.forEach(function(k) {
            if (d.TimeMoving >= a.Length[k][0] &&
                d.TimeMoving <= a.Length[k][1]) {
              d.LapType = k;
            }
          });
          if (!d.LapType) {
            d.LapType = "Unknown1";
          }
        } else {
          d.LapType = "Unknown2";
        }
}
      });
      
      facts.add(data);
      
      redraw();

      if ((complete/total) == 1) {
        d3.select('.progress').style('display', 'none');
      }

    });
    
  });
});

  
} catch (e) {
  console.log("ERROR",e);
  alert(e.message);
}
    </script>
  </body>
</html>
