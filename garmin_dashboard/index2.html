
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/favicon.ico">

    <title>Garmin Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href="/bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles -->
    <style>
    body {
      padding-top: 60px;
    }

    @media all and (max-width: 1439px) {
      body { margin: 0px auto; }
      .axis { position: static; }
      .axis.top, .axis.bottom { padding: 0; }
    }
    
    #chart-lap-distance tbody tr.dc-table-row {
        cursor: pointer;
    }

    #chart-lap-distance tbody tr.dc-table-row:hover {
        fill-opacity: 0.6;
    }
    
    </style>
    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="/bower_components/jquery/dist/jquery.js"></script>
    <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    
    <!-- Charting JavaScript -->
    <script src='/bower_components/colorbrewer/colorbrewer.js' type='text/javascript'></script>
    <script src='/bower_components/d3/d3.js' type='text/javascript'></script>
    <script src='/bower_components/crossfilter2/crossfilter.js' type='text/javascript'></script>
    <script src='/bower_components/dc.js/dc.js' type='text/javascript'></script>
    <link href='/bower_components/dc.js/dc.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/datatables/media/js/jquery.dataTables.js' type='text/javascript'></script>
    <script src='/bower_components/datatables/media/js/dataTables.bootstrap.js' type='text/javascript'></script>
    <link href='/bower_components/datatables/media/css/dataTables.bootstrap.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/cubism/cubism.v1.js' type='text/javascript'></script>
    <script src='/bower_components/d3-queue/d3-queue.js' type='text/javascript'></script>
    
    <script src='/utils.js' type='text/javascript'></script>
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Garmin Dashboard</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <div class="progress" style="margin-top:15px;">
            <div class="progress-bar progress-bar-success" style="width: 0%">
              <span class="sr-only">Complete</span>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container" role="main">
      
      <div class="row">
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Year <small>Distance</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-year"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Month <small>Distance</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-month"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Day <small>Distance</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-weekday"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Hour <small>Distance</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-hour"></div>
            </div>
          </div>
        </div>
      </div>
        
      <div class="row">
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Activity</h3>
            </div>
            <div class="panel-body">
              <div id="chart-activity"></div>
              <div id="chart-filename"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Lap <small>Distance / Time</small></h3>
            </div>
            <div class="panel-body">
              <table id="chart-lap-distance" class="table table-condensed">
<thead>
<tr>
<th>Type</th>
<th>Distance</th>
</tr>
</thead>
</table>
              <div id="chart-lap-time"></div>
              <table class="table table-condensed" id="chart-stats-lap"></table>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Lap <small>Type</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-lap-type"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Stats</h3>
            </div>
            <div class="panel-body">
              <table class="table table-condensed">
                <tr><th>Points</th><td id="chart-stats-points"></td></tr>
                <tr><th>Distance</th><td id="chart-stats-distance"></td></tr>
                <tr><th>Elapsed Time</th><td id="chart-stats-time"></td></tr>
                <tr><th>Moving Time</th><td id="chart-stats-mtime"></td></tr>
                <tr><th>Avg Pace</th><td id="chart-stats-pace"></td></tr>
                <tr><th>Avg Speed</th><td id="chart-stats-speed"></td></tr>
                <tr><th>Avg Meters/Min</th><td id="chart-stats-mm"></td></tr>
                <tr><th>Avg HR</th><td><span id="chart-stats-hr"></span> <small>bpm</small></td></tr>
                <tr><th>Avg Cadence</th><td id="chart-stats-cad"> spm</td></tr>
              </table>
            </div>
          </div>
        </div>
      </div>
        
      <div class="row">
        <div class="col-sm-4">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Not sure</h3>
            </div>
            <div class="panel-body">
              <table class="table table-bordered table-hover" id="file-table">
                <thead>
                  <tr>
                    <th>File</th>
                    <th>Activity</th>
                  </tr>
                </thead>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      
      <div class="row">
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Heart Rate / Time</h3>
            </div>
            <div class="panel-body">
              <div id="chart-hr-time"></div>
              <table class="table table-condensed" id="chart-stats-hr"></table>
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Speed <small>Distance / Time</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-speed-time"></div>
              <table class="table table-condensed" id="chart-stats-speeddddd"></table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-12">
          <table class="table table-bordered table-hover" id="data-table">
            <thead>
              <tr>
                <th>File</th>
                <th>Activity</th>
                <th>Time</th>
                <th>Distance</th>
                <th>Speed</th>
                <th>Heart Rate</th>
                <th>Section</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>

    </div><!-- /.container -->

    <script>
try{


var timeParser = d3.time.format.iso;
var timeFormat = d3.time.format('%c');
var hrf = d3.time.format('%H');
var wdf = d3.time.format('%w.%A');
var timeScale = d3.time.second;
var filenameColors = d3.scale.category10();

var facts = crossfilter();

function FileMovingTimeDate(d) {
  this.f = d.File;
  this.m = d.TimeMoving;
  this.t = d.Time;
}
FileMovingTimeDate.prototype.valueOf = function() {
  // from utils.js dateToInterval
  var scale = timeScale;
  var interval = 10;
  
  var date = this.m
  var subHalf = scale.offset(date, -1 * interval / 2);
  var addHalf = scale.offset(date, interval / 2);
  date = scale.range(subHalf, addHalf, interval)[0];
  
  return date.getTime();
};


function datatable_reduce(group) {
  function add(p, v, nf) {
    if (!p.has(v.File)) {
      p.set(v.File, d3.map());
    }
    
    if (p.get(v.File).has(v.PointIndex)) {
      console.log('filetable already has index for point',v.File,v.PointIndex,p.get(v.File).has(v.PointIndex));
    }
    
    p.get(v.File).set(v.PointIndex,v);
    return p;
  }
  
  function rem(p, v, nf) {
    
    if (!p.has(v.File)) {
      return p;
    }
    
    if (!p.get(v.File).has(v.PointIndex)) {
      return p;
    }
    
    p.get(v.File).remove(v.PointIndex);
    
    if (p.get(v.File).empty()) {
      p.remove(v.File);
    }
    return p;
  }
  
  function init() {
    return d3.map();
  }
  
  return group.reduce(add,rem,init);
}

function filetable_reduce(group) {
  function add(p, v, nf) {
    if (p.has(v.PointIndex)) {
      console.log('filetable already has index for point',v.PointIndex,p.get(v.PointIndex));
    }
    p.set(v.PointIndex,v);
    return p;
  }
  
  function rem(p, v, nf) {
    if (p.has(v.PointIndex)) {
      p.remove(v.PointIndex);
    }
    return p;
  }
  
  function init() {
    return d3.map();
  }
  
  return group.reduce(add,rem,init);
}


var filenameDim = facts.dimension(function(d) { return d.File; });
var activityDim = facts.dimension(function(d) { return d.Activity; });
var lapDim = facts.dimension(function(d) { return d.Lap; });
var lapTypeDim = facts.dimension(function(d) { return d.LapType; });
var hrTimeDim = facts.dimension(function(d) { return new FileMovingTimeDate(d); });
var dataTableDim = facts.dimension(function(d) { 
  // from utils.js dateToInterval
  var scale = timeScale;
  var interval = 10;
  
  var date = d.TimeMoving;
  var subHalf = scale.offset(date, -1 * interval / 2);
  var addHalf = scale.offset(date, interval / 2);
  date = scale.range(subHalf, addHalf, interval)[0];
  
  return date.getTime();
});
var speedTimeDim = facts.dimension(function(d) { return new FileMovingTimeDate(d); });
var movingTimeDim = facts.dimension(function(d) { return d.TimeMoving; });
var dataTableGroup = flatten_group(datatable_reduce(dataTableDim.group()), function(arr) {
  return function(d) {
    d.value.values().forEach(function(points) {
      points.values().forEach(function(p) {
        arr.push(p);
      });
    });
    return d;
  }
});
var fileTableDim = facts.dimension(function(d) { return [d.File, d.Activity]; });
var fileTableGroup = filetable_reduce(filenameDim.group());
var timeHRDim = facts.dimension(function(d) { return hrf(d.Time); });
var timeWDDim = facts.dimension(function(d) { return wdf(d.Time); });

var chartActivity = dc.rowChart("#chart-activity");
var chartFilename = dc.rowChart("#chart-filename");
var chartLapDistance = dc.dataTable("#chart-lap-distance");
var chartLapTime = dc.pieChart("#chart-lap-time");
var chartLapType = dc.rowChart("#chart-lap-type");
var chartPointsCount = dc.numberDisplay("#chart-stats-points");
var chartTotalDistance = dc.numberDisplay("#chart-stats-distance");
var chartTotalTime = dc.numberDisplay("#chart-stats-time");
var chartMovingTime = dc.numberDisplay("#chart-stats-mtime");
var chartAvgPace = dc.numberDisplay("#chart-stats-pace");
var chartAvgMM = dc.numberDisplay("#chart-stats-mm");
var chartAvgSpeed = dc.numberDisplay("#chart-stats-speed");
var chartAvgHR = dc.numberDisplay("#chart-stats-hr");
var chartYear = dc.rowChart("#chart-year");
var chartMonth = dc.rowChart("#chart-month");
var chartTimeHR = dc.rowChart("#chart-hour");
var chartTimeWD = dc.rowChart("#chart-weekday");


// allow composite chart to brush!
// https://github.com/dc-js/dc.js/issues/878
(function() {
    var compositeChart = dc.compositeChart;
    dc.compositeChart = function(parent, chartGroup) {
        var _chart = compositeChart(parent, chartGroup);
        
        _chart._brushing = function () {
            var extent = _chart.extendBrush();
            var rangedFilter = null;
            if(!_chart.brushIsEmpty(extent)) {
                rangedFilter = dc.filters.RangedFilter(extent[0], extent[1]);
            }

            dc.events.trigger(function () {
                if (!rangedFilter) {
                    _chart.filter(null);
                } else {
                    _chart.replaceFilter(rangedFilter);
                }
                _chart.redrawGroup();
            }, dc.constants.EVENT_DELAY);
        };
        
        return _chart;
    };
})();

var chartHRTime = dc.compositeChart("#chart-hr-time");
var chartSpeedTime = dc.compositeChart("#chart-speed-time");


var dataTable = $("#data-table").dataTable({
  "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
  "footerCallback": function ( row, data, start, end, display ) {
  },
  "order": [[0, 'desc']],
  "dom": 'T<"clear-l"l><"clear-l"i><"clear-r"f><"clear-r"p>t',
  "tableTools": {
    "sSwfPath": "copy_csv_xls_pdf.swf"
  },
  columnDefs: [
    {
      targets: 0,
      data: function(d) { return d.File + " " + timeFormat(d.Time) + " ["+ formatSeconds(d.TimeMoving/1000) +"] ("+formatSeconds(d.TimeElapsed/1000)+") "; }
//return JSON.stringify(d); }
    },
    {
      targets: 1,
      data: function(d) { return d.Activity; }
    },
    {
      targets: 2,
      data: function(d) { return d.TimePoint; }
    },
    {
      targets: 3,
      data: function(d) { return d.DistancePoint; }
    },
    {
      targets: 4,
      data: function(d) { return d3.round(d.SpeedMS,3) + "m/s " + d3.round(d.SpeedKH,3) + "km/h " + formatSeconds(d.PaceSK,false) + "m/km"; }
    },
    {
      targets: 5,
      data: function(d) { return d.HeartRate; }
    },
    {
      targets: 6,
      data: function(d) { return d.LapType; }
    }
  ]
});


var fileTable = $("#file-table").dataTable({
  paging:false,
  searching:false,
  bInfo: false, //remove showing x of y
  select: true,
  "order": [[0, 'desc']],
  columnDefs: [
    {
      targets: 0,
      data: function(d) { return d.key; }
    },
    {
      targets: 1,
      data: function(d) { 
        return JSON.stringify(d3.set(d.value.values().map(function(d) {
          return d.Activity;
        })).values());
      }
    }
  ]
});


function flatten_group(group, fn) {
  return {
    all:function () {
      var everything = [];
      group.all().forEach(fn(everything));
      return everything;
    }
  };
}

for (var i = 0; i < dc.chartRegistry.list().length; i++) {
  var chartI = dc.chartRegistry.list()[i];
  chartI.on("filtered.table", refreshDataTable);
}

function refreshDataTable(chart,filter,data) {
  
  return;
  
  dc.events.trigger(function () {
    if (data){
      dataTable.api()
        .rows.add(data)
        .draw();
    } else {
      dataTable.api()
        .clear()
        .rows.add(dataTableGroup.all())
        .draw();
    }
    
    fileTable.api()
      .clear()
      .rows.add(fileTableGroup.all())
      .draw();
    
    chartHRTimeXScale
      .domain(
        d3.extent(hrTimeGroup.all(), 
          function(d) { return chartHRTime.keyAccessor()(d); }));
    
    function get_all_values(group) {
      return {
        all:function () {
          
          var everything = [];
          
          group.all().forEach(function(d) {
            d.value.forEach(function(activity,values) {
              values.forEach(function(d) {
                everything.push(d);
              });
            });
          });
          
          return everything;
        }
      };
    }
        
    chartHRTimeYScale.domain(d3.extent(get_all_values(hrTimeGroup).all())); 
    chartSpeedTimeYScale.domain(d3.extent(get_all_values(speedTimeGroup).all())); 
    
    chartHRTime.redraw();
    chartSpeedTime.redraw();
    
  });
}

var redraw_count = 0;
function redraw() {
  if (facts.size() > 0) {
    if (redraw_count == 0) {
      dc.renderAll();
    } else {
      dc.redrawAll();
    }
    // actually finished with loading data
    if (load_interval == undefined)
      refreshDataTable();
    redraw_count++;
  }
}

chartActivity
  .dimension(activityDim)
  .elasticX(true)
  .group(activityDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .xAxis().ticks([5]).tickFormat(function(d) { 
    return d3.round(d / 1000,2) + " km";
});

chartFilename
  .colors(filenameColors)
  .dimension(filenameDim)
.on('postRender', function(){
interval_render_done = true;
})
.on('postRedraw', function(){
interval_render_done = true;
})
  .elasticX(true)
  .group(filenameDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .xAxis().ticks([5]).tickFormat(function(d) { 
    return d3.round(d / 1000,2) + " km";
});
  
var keyFunc = function(d) { return d._activity.File + d.Index; };
var lapDistanceGroup = lapTypeDim.group().reduce(
	function(p,v) {
	  if (!p.has(keyFunc(v))) {
	    p.set(keyFunc(v),v);
	  }
	  return p;
    }, function(p,v) {
	  if (p.has(keyFunc(v))) {
	    p.remove(keyFunc(v));
	  }
      return p;
    }, function() {
      return d3.map();
    });

chartLapDistance
  .width(200)
  .height(200)
  .size(50)
  .dimension({
      filter: function(f) {
        lapTypeDim.filter(f);
      },
      filterExact: function(v) {
        lapTypeDim.filterExact(v);
      },
      bottom: function(sz) {
        var gdata = lapDistanceGroup.top(Infinity);
		var arr = [];
		gdata.forEach(function(typedata) {
			typedata.value.forEach(function(k,v) {
				arr.push(v);
			});
		});
        
        var nested = d3.nest()
        .key(function(d) { return d.Activity; })
        .key(function(d) { return d.LapType })
        .rollup(function(a) { return d3.sum(a, function(d) { return d.DistancePoint; });  })
        .entries(arr);
        
        var values = []
        nested.forEach(function(activity) {
          activity.values.forEach(function(lapType) {
            values.push({
              Activity: activity.key,
              LapType: lapType.key,
              DistanceType: lapType.values
            });
          });
        });
        return values;
      }
  })
  .group(function(d) { return d.Activity; })
  .columns([
    function(d) { return d.LapType; },
    function(d) { return d3.round(d.DistanceType / 1000,2) + " km"; }
  ])
  .on('renderlet', function(chart) {
    
    chart.selectAll('.dc-table-row')
      .on('click', function(d) {
        dc.events.trigger(function () {
          chart.filter(d.LapType);
          chart.redrawGroup();
        });
        
      });
    
  });




/*
  .elasticX(true)
  .cap(8)
  .ordering(function(d) { return d.value; })
  //.data(function(g) { return g.top(5); })
  .dimension(lapDim)
  .group(lapDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .valueAccessor(function(d) { return d.value; })
  .title(function(d) {
    return d.key + ": " + d3.round(d.value / 1000) + " km";
  })
  .on('renderlet', function(chart) {
    //console.log('lap distance', chart.data(), chart.group().all());
  })
  .xAxis().ticks([5]).tickFormat(function(d) { 
    return d3.round(d / 1000,2) + " km";
});*/
  
chartLapTime
  .width(200)
  .innerRadius(20)
  .dimension(lapDim)
  .group(lapDim.group().reduceSum(function(d) { return d.TimePoint; }))
  .valueAccessor(function(d) { return d.value; })
  .title(function(d) {
    return d.key + ": " + formatSeconds(d3.round(d.value / 1000));
  });

chartLapType
  .dimension(lapTypeDim)
  .elasticX(true)
  .group(lapTypeDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .xAxis().ticks([5]).tickFormat(function(d) { 
    return d3.round(d / 1000,2) + " km";
});

chartPointsCount
  .group(facts.groupAll().reduceCount())
  .formatNumber(d3.round)
  .valueAccessor(function(d) { return d; });
  
chartTotalDistance
  .group(facts.groupAll().reduceSum(function(d) { return d.DistancePoint; }))
  .formatNumber(function(d) {
    return d3.round(d / 1000,2) + " km";
  })
  .valueAccessor(function(d) { return d; });
  
chartTotalTime
  .group(facts.groupAll().reduceSum(function(d) { return d.TimePoint; }))
  .formatNumber(function(d) {
    return formatSeconds(d3.round(d / 1000));
  })
  .valueAccessor(function(d) { return d; });

chartAvgPace
  .group(facts.groupAll().reduce
(function(p,v) {
      p.count++;
      p.total+=v.PaceSK;
      return p;
    }, function(p,v) {
      p.count--;
      p.total-=v.PaceSK;
      return p;
    }, function() {
      return {count:0, total:0};
    }))
  .formatNumber(function(d) {
return formatSeconds(d,false) +" m/km";
})
  .valueAccessor(function(d) { 
if (d.count==0) return 0;
return d.total/d.count;
});


chartAvgMM
  .group(facts.groupAll().reduce
(function(p,v) {
      p.count++;
      p.total+=v.SpeedMM;
      return p;
    }, function(p,v) {
      p.count--;
      p.total-=v.SpeedMM;
      return p;
    }, function() {
      return {count:0, total:0};
    }))
  .formatNumber(function(d) {
return d3.round(d,3) +" m/m";
})
  .valueAccessor(function(d) { 
if (d.count==0) return 0;
return d.total/d.count;
});

chartAvgSpeed
  .group(facts.groupAll().reduce
(function(p,v) {
      p.count++;
      p.total+=v.SpeedKH;
      return p;
    }, function(p,v) {
      p.count--;
      p.total-=v.SpeedKH;
      return p;
    }, function() {
      return {count:0, total:0};
    }))
  .formatNumber(function(d) {
return d3.round(d,3) +" km/h";
})
  .valueAccessor(function(d) { 
if (d.count==0) return 0;
return d.total/d.count;
});
  
chartAvgHR
  .group(facts.groupAll().reduce
(function(p,v) {
      p.count++;
      p.total+=v.HeartRate;
      return p;
    }, function(p,v) {
      p.count--;
      p.total-=v.HeartRate;
      return p;
    }, function() {
      return {count:0, total:0};
    }))
  .formatNumber(function(d) {
return d3.round(d,0);
})
  .valueAccessor(function(d) { 
if (d.count==0) return 0;
return d.total/d.count;
});

chartMovingTime
  .group(facts.groupAll().reduceSum(function(d) { 
    return d.LapType == "Stationary" ? 0 : d.TimePoint; }))
  .formatNumber(function(d) {
    return formatSeconds(d3.round(d / 1000));
  })
  .valueAccessor(function(d) { return d; });


var    tf = d3.time.format('%A %b %e %Y'),
    mf = d3.time.format('%m.%B'),
    yf = d3.time.format('%Y');

var yearDim = facts.dimension(function(d) { return yf(d.Time); });
var monthDim = facts.dimension(function(d) { return mf(d.Time); });

chartYear
  .elasticX(true)
//  .label(function (d) { return d.key.split(".")[1]; })
  .dimension(yearDim)
  .group(yearDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .xAxis().ticks([5]).tickFormat(function(d) { 
    return d3.round(d / 1000,2) + " km";
});
  
chartMonth
  .elasticX(true)
  .label(function (d) { return d.key.split(".")[1]; })
  .dimension(monthDim)
  .group(monthDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .xAxis().ticks([5]).tickFormat(function(d) { 
    return d3.round(d / 1000,2) + " km";
});

chartTimeHR
  .elasticX(true)
  .dimension(timeHRDim)
  .group(timeHRDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .xAxis().ticks([5]).tickFormat(function(d) { 
    return d3.round(d / 1000,2) + " km";
});

chartTimeWD
  .elasticX(true)
  .dimension(timeWDDim)
  .group(timeWDDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .label(function (d) { return d.key.split(".")[1]; })
  .xAxis().ticks([5]).tickFormat(function(d) { 
    return d3.round(d / 1000,2) + " km";
});

function reduceWorklog(group, a_kfn, a_vfn) {
  function default_kfn(d) {
    return d.File;
  }
  
  function default_vfn(d) {
    return d['HeartRate'];
  }

  var vfn = a_vfn;
  if (!vfn) vfn = default_vfn;
  
  var kfn = a_kfn;
  if (!kfn) kfn = default_kfn;

  function add(p, v, nf) {
    if (!p.has(kfn(v))) {
      p.set(kfn(v), []);
    }
    /* else {
      console.log('WEEKS REDUCE EXISTS',kfn(v),v);
    }*/
    
    p.get(kfn(v)).push(vfn(v));
    //p.set(kfn(v), p.get(kfn(v))+vfn(v));
    return p;
  }
  
  function rem(p, v, nf) {
    
    var upd = [];
    var removed = false;
    
    p.get(kfn(v)).forEach(function(d) {
      if (!removed && d == vfn(v)) {
        removed = true;
      } else {
        upd.push(d);
      }
    });
    
    p.set(kfn(v), upd);
    
    if (upd.length == 0) {
      p.remove(kfn(v));
    }
    
    return p;
  }
  
  function init() {
    return d3.map()
  }
  return group.reduce(add,rem,init);
}




var hrTimeGroup = reduceWorklog(hrTimeDim.group());
var speedTimeGroup = reduceWorklog(hrTimeDim.group(),
undefined,
  function (d) {
//stationary
if (d.SpeedKH < 1) {
return 0; 
}
/*
//walking - makes chart pointy
if (d.SpeedKH < 6) {
return 0;
}
//flying
if (d.SpeedKH > 18) {
return 0;
}
*/
    return d.PaceSK;
  }
);

var chartHRTimeXScale = d3.scale.linear();
    
var chartHRTimeYScale = d3.scale.linear(); 
var chartSpeedTimeYScale = d3.scale.linear(); 

var hrSeriesCharts = [];
var speedSeriesCharts = [];

function addSpeedAverageChart(parent) {
  var lc = dc.lineChart(parent);
  
  lc
    .interpolate('step')
    .colors('grey')
    .dashStyle([2,2])
    .dimension(hrTimeDim)
    .group(remove_empty_bins(lc, speedTimeGroup), 'Average')
    .valueAccessor(function(d) {
      var ret = {count: 0, total: 0};
      d.value.forEach(function(activity,values) {
        values.forEach(function(d) {
          ret.count++;
          ret.total += d;
        });
      });
      
      if (ret.count == 0) return 0;
      return ret.total/ret.count;
    })
    .keyAccessor(function(d) { return d.key.m; });
    
  speedSeriesCharts.push(lc);
  
  return speedSeriesCharts;
}
function addHrAverageChart(parent) {
  var lc = dc.lineChart(parent);
  
  lc
    .interpolate('basis')
    .colors('grey')
    .dashStyle([2,2])
    .dimension(hrTimeDim)
    .group(remove_empty_bins(lc, hrTimeGroup), 'Average')
    .valueAccessor(function(d) {
      var ret = {count: 0, total: 0};
      d.value.forEach(function(activity,values) {
        values.forEach(function(d) {
          ret.count++;
          ret.total += d;
        });
      });
      
      if (ret.count == 0) return 0;
      return ret.total/ret.count;
    })
    .keyAccessor(function(d) { return d.key.m; });
    
  hrSeriesCharts.push(lc);
  
  return hrSeriesCharts;
}

chartSpeedTime
  .width(500)
  .height(200)
  .x(chartHRTimeXScale)
  .y(chartSpeedTimeYScale)
  .legend(dc.legend())
  .compose(addSpeedAverageChart(chartSpeedTime))
  .dimension(hrTimeDim);

chartSpeedTime.xAxis().tickFormat(function(d) {
  return formatSeconds(d/1000,false);
});

chartSpeedTime.margins().left = 40;
chartSpeedTime.yAxis().tickFormat(function(d) {
  return formatSeconds(d,false);
});

chartHRTime
  .width(500)
  .height(200)
  .x(chartHRTimeXScale)
  .y(chartHRTimeYScale)
  //.elasticY(true)
  .legend(dc.legend())
  .compose(addHrAverageChart(chartHRTime))
  .dimension(hrTimeDim);

chartHRTime.margins().left = 40;
chartHRTime.xAxis().tickFormat(function(d) {
  return formatSeconds(d/1000,false);
});


var redraw_count = 0;
function redraw() {
  if (facts.size() > 0) {
    if (redraw_count == 0) {
      dc.renderAll();
    } else {
      dc.redrawAll();
    }
    refreshDataTable();
    redraw_count++;
  }
}


redraw();

var interval_render_done = true;
var load_interval = setInterval(load_data, 200);
var load_count = 5000;
var load_complete = false;
var data_toload = [];
var data_toload_total = 0;
var data_toload_complete = 0;

function load_data() {
  //console.log('load_data',load_complete,data_toload.length,interval_render_done);

if (facts.size() > 0 && !interval_render_done) {
// alert('bail'+facts.size()+' '+data_toload.length);
 return; }
  
  if (load_complete && !data_toload.length)
  {
    clearInterval(load_interval);
    load_interval = undefined;
    
    d3.select('.progress').style('display', 'none');
      refreshDataTable();
    console.log('done loading data');
    return;
  }
  
  var toadd = data_toload.splice(0,Math.min(load_count,data_toload.length));
  
  data_toload_complete += toadd.length;
          
  //console.log('adding',toadd.length,((data_toload_complete/data_toload_total)*100));
  
  setTimeout(function() {
    d3.select('.progress-bar').classed('progress-bar-success', true).style('width', ((data_toload_complete/data_toload_total)*100)+'%');
  }, 0);
          
  facts.add(toadd);
 interval_render_done = false; 
 // refreshDataTable(undefined,undefined,toadd);
  
  redraw();
}


d3.csv('/activities.csv', function(activities) {
  console.log('activities',activities);
  redraw();
  
  var total = activities.length;
  var complete = 0;
  
  var queue = d3.queue();

  for(var i = 0; i < total; i++) {
    var a = activities[i];
    
    if (a.File == "" || a.Name == undefined || a.File[0] == '#') {
      console.log('Skipped',a);
      continue;
    }
    
    // length represents the type of workout, in minutes
    var lenRegex = /^([0-9]+)\-([0-9]+)\-([0-9]+)$/g;
    var lenMatch = lenRegex.exec(a.Length);
    if (lenMatch != null) {
      var start = 0;
      var lenWarmup = +lenMatch[1]*60*1000;
      var lenWorkout = +lenMatch[2]*60*1000;
      var lenCooldown = +lenMatch[3]*60*1000;
      
      var warmupEnd = start + lenWarmup;
      var workoutEnd = warmupEnd + lenWorkout;
      var cooldownEnd = workoutEnd + lenCooldown;
      
      a.Length = {
        Warmup: [0, warmupEnd], 
        Workout: [warmupEnd, workoutEnd], 
        CoolDown: [workoutEnd,cooldownEnd]};
    } else if (/^[0-9]+$/) {
      a.Length = {Workout: [0,+a.Length*60*1000]};
    } else {
      console.log("Activity has invalid length " + a.Length,a);
    }
    
    queue.defer(function(activity, cb) {
      console.log('/activities/'+activity.File);
      d3.csv('/activities/'+activity.File, function(d,i) {
        d._activity = activity;
      
        d.File = activity.File;
        d.Lap = +d.Lap;
        d.Distance = +d.Distance;
        d.Time = timeParser.parse(d.Time);
        d.TimeInterval = dateToInterval(d, 'Time', timeScale, 1);
        d.HeartRate = +d['Heart Rate'];
        delete d['Heart Rate'];
        
        if (d.HeartRate > 200) {
          console.log('**MAX HR',d.HeartRate,d);
        }
        
        return d;
      }, function(err,data) {
        console.log(err,data);
        d3.select('.progress-bar').classed('progress-bar-success', true).style('width', ((++complete/total)*100)+'%');
        cb(err,data);
      });
    }, a);
  }
  
  queue.awaitAll(function(err, activities) {
    console.log('got all', err, activities);
  
    data_toload_complete = 0;
    data_toload_total = 0;
    for(var ai = 0; ai < activities.length; ai++) {
      data_toload_total += activities[ai].length;
    }
  
    for(var ai = 0; ai < activities.length; ai++) {
      var a = undefined;
      var data = activities[ai];
      
      var lengthKeys = []
      var elapsedTime = 0;
      var movingTime = 0;
      
      for (var i = 0; i < activities[ai].length; i++) {
        var d = activities[ai][i];
        if (a == undefined || i == 0) {
          a = d._activity;
          
          lengthKeys = d3.keys(a.Length);
          
          elapsedTime = 0;
          movingTime = 0;
            
          console.log('activity',a,activities[ai]);
            
          function stackActivity(a) {
            
            var lc = dc.lineChart(chartSpeedTime);
            
            lc.dimension(hrTimeDim)
              .group(remove_empty_bins(lc, speedTimeGroup), a)
              .colors(filenameColors(a))
              .valueAccessor(function(d) {
                var ret = {count: 0, total: 0};
                if (d.value.has(a)) {
                  d.value.get(a).forEach(function(d) {
                    ret.count++;
                    ret.total += d;
                  });
                }
                if (ret.count == 0) return 0;
                return ret.total/ret.count;
              })
              .keyAccessor(function(d) { return d.key.m; });
            
            speedSeriesCharts.push(lc);
            chartSpeedTime.compose(speedSeriesCharts);
            chartSpeedTime.render();
            

           lc = dc.lineChart(chartHRTime);
            
            lc.dimension(hrTimeDim)
              .group(remove_empty_bins(lc, hrTimeGroup), a)
              .colors(filenameColors(a))
              .valueAccessor(function(d) {
                var ret = {count: 0, total: 0};
                if (d.value.has(a)) {
                  d.value.get(a).forEach(function(d) {
                    ret.count++;
                    ret.total += d;
                  });
                }
                if (ret.count == 0) return 0;
                return ret.total/ret.count;
              })
              .keyAccessor(function(d) { return d.key.m; });
            hrSeriesCharts.push(lc);
            chartHRTime.compose(hrSeriesCharts);
            chartHRTime.render();
          }
          
          stackActivity(a.File);
        }
        
    
      //TODO dynamic stacks based on activity filename
      //chartHRTime.stack(chartWeeksGroup, a.File, chartWeeksGroupAccessor(a.File))
      
        //data.forEach(function(d,i,arr) {
          d.PointIndex = i;
          d.Activity = a.Name;
          d.ActivityLength = a.Length;
          d.DistancePoint = i == 0 ? d.Distance : d.Distance - data[i-1].Distance;
          d.TimePoint = i == 0 ? 1000 : d.Time - data[i-1].Time;

          elapsedTime += d.TimePoint;
          d.TimeElapsed = elapsedTime;

          //calc speed with rolling window across multiple data points. sometimes distance is recorded as 0 between points, artifically creating "faster" points
          var window = 5;
          var right = Math.min(i+window,data.length-1);
          var left = Math.max(i-window,0);
          var first = data[left];
          var last = data[right];
          var t = last.Time - first.Time;
          var l = last.Distance - first.Distance;

          d.SpeedMS = (l/(t/1000));
          d.SpeedKH = d.SpeedMS * 3.6;
          d.SpeedMM = d.SpeedMS * 60;
          d.PaceSK = 1000 / d.SpeedMS;
          d.PaceSM = 1609.344 / d.SpeedMS;
          
          if (d.SpeedKH < 1) {
            d.LapType = "Stationary";
            d.TimeMoving = movingTime;
          } else {
            movingTime += d.TimePoint;
            d.TimeMoving = movingTime;

          if (lengthKeys.length == 1) {
            d.LapType = lengthKeys[0];
          } else if (lengthKeys.length == 3) {
            lengthKeys.forEach(function(k) {
              if (d.TimeMoving >= a.Length[k][0] &&
                  d.TimeMoving <= a.Length[k][1]) {
                d.LapType = k;
              }
            });
            if (!d.LapType) {
              d.LapType = "Unknown1";
            }
          } else {
            d.LapType = "Unknown2";
          }
  }

          data_toload.push(d);
          
        //});
      
      }
    
    }
    
    
    load_complete = true;
    
  });
});

  
} catch (e) {
  console.log("ERROR",e);
  alert(e.message);
}
    </script>
  </body>
</html>
