
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/favicon.ico">

    <title>Garmin Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href="/bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles -->
    <style>
    body {
      padding-top: 60px;
    }

    @media all and (max-width: 1439px) {
      body { margin: 0px auto; }
      .axis { position: static; }
      .axis.top, .axis.bottom { padding: 0; }
    }
    
    </style>
    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="/bower_components/jquery/dist/jquery.js"></script>
    <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    
    <!-- Charting JavaScript -->
    <script src='/bower_components/colorbrewer/colorbrewer.js' type='text/javascript'></script>
    <script src='/bower_components/d3/d3.js' type='text/javascript'></script>
    <script src='/bower_components/crossfilter2/crossfilter.js' type='text/javascript'></script>
    <script src='/bower_components/dc.js/dc.js' type='text/javascript'></script>
    <link href='/bower_components/dc.js/dc.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/datatables/media/js/jquery.dataTables.js' type='text/javascript'></script>
    <script src='/bower_components/datatables/media/js/dataTables.bootstrap.js' type='text/javascript'></script>
    <link href='/bower_components/datatables/media/css/dataTables.bootstrap.css' rel='stylesheet' type='text/css'>
    <script src='/bower_components/cubism/cubism.v1.js' type='text/javascript'></script>
    
    <script src='/utils.js' type='text/javascript'></script>
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Garmin Dashboard</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container" role="main">

      <div class="row">
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Activity</h3>
            </div>
            <div class="panel-body">
              <div id="chart-activity"></div>
              <div id="chart-filename"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Lap <small>Distance / Time</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-lap-distance"></div>
              <div id="chart-lap-time"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Lap <small>Type</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-lap-type"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Stats</h3>
            </div>
            <div class="panel-body">
              <table class="table table-condensed">
                <tr><th>Points</th><td id="chart-stats-points"></td></tr>
                <tr><th>Distance</th><td id="chart-stats-distance"></td></tr>
                <tr><th>Elapsed Time</th><td id="chart-stats-time"></td></tr>
                <tr><th>Moving Time</th><td id="chart-stats-mtime"></td></tr>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Heart Rate / Time</h3>
            </div>
            <div class="panel-body">
              <div id="chart-laps-time"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Speed <small>Distance / Time</small></h3>
            </div>
            <div class="panel-body">
              <div id="chart-distance-time"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-12">
          <table class="table table-bordered table-hover" id="data-table">
            <thead>
              <tr>
                <th>File</th>
                <th>Activity</th>
                <th>Time</th>
                <th>Distance</th>
                <th>Heart Rate</th>
                <th>Section</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>

    </div><!-- /.container -->

    <script>
try{

var timeParser = d3.time.format.iso;
var timeFormat = d3.time.format('%c');
var facts = crossfilter();

var filenameDim = facts.dimension(function(d) { return d.File; });
var activityDim = facts.dimension(function(d) { return d.Activity; });
var lapDim = facts.dimension(function(d) { return d.Lap; });
var lapTypeDim = facts.dimension(function(d) { return d.LapType; });

var chartActivity = dc.pieChart("#chart-activity");
var chartFilename = dc.pieChart("#chart-filename");
var chartLapDistance = dc.pieChart("#chart-lap-distance");
var chartLapTime = dc.pieChart("#chart-lap-time");
var chartLapType = dc.pieChart("#chart-lap-type");
var chartPointsCount = dc.numberDisplay("#chart-stats-points");
var chartTotalDistance = dc.numberDisplay("#chart-stats-distance");
var chartTotalTime = dc.numberDisplay("#chart-stats-time");
var chartMovingTime = dc.numberDisplay("#chart-stats-mtime");



var dataTable = $("#data-table").dataTable({
  "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
  "footerCallback": function ( row, data, start, end, display ) {
  },
  "order": [[0, 'desc']],
  "dom": 'T<"clear-l"l><"clear-l"i><"clear-r"f><"clear-r"p>t',
  "tableTools": {
    "sSwfPath": "copy_csv_xls_pdf.swf"
  },
  columnDefs: [
    {
      targets: 0,
      data: function(d) { return d.File + " " + timeFormat(d.Time); }
//return JSON.stringify(d); }
    },
    {
      targets: 1,
      data: function(d) { return d.Activity; }
    },
    {
      targets: 2,
      data: function(d) { return d.TimePoint; }
    },
    {
      targets: 3,
      data: function(d) { return d.DistancePoint; }
    },
    {
      targets: 4,
      data: function(d) { return d.HeartRate; }
    },
    {
      targets: 5,
      data: function(d) { return d.LapType; }
    }
  ]
});

for (var i = 0; i < dc.chartRegistry.list().length; i++) {
  var chartI = dc.chartRegistry.list()[i];
  chartI.on("filtered", refreshDataTable);
}

function refreshDataTable() {
  dc.events.trigger(function () {
    
    dataTable.api()
      .clear()
      .rows.add(facts.allFiltered())
      .draw();
  });
}

chartActivity
  .width(200)
  .innerRadius(20)
  .dimension(activityDim)
  .group(activityDim.group().reduceCount())
  .valueAccessor(function(d) { return d.value; });
  
chartFilename
  .width(200)
  .innerRadius(20)
  .dimension(filenameDim)
  .group(filenameDim.group().reduceCount())
  .valueAccessor(function(d) { return d.value; });
  
chartLapDistance
  .width(200)
  .innerRadius(20)
  .dimension(lapDim)
  .group(lapDim.group().reduceSum(function(d) { return d.DistancePoint; }))
  .valueAccessor(function(d) { return d.value; })
  .title(function(d) {
    return d.key + ": " + d3.round(d.value / 1000) + " km";
  });
  
chartLapTime
  .width(200)
  .innerRadius(20)
  .dimension(lapDim)
  .group(lapDim.group().reduceSum(function(d) { return d.TimePoint; }))
  .valueAccessor(function(d) { return d.value; })
  .title(function(d) {
    return d.key + ": " + formatSeconds(d3.round(d.value / 1000));
  });

chartLapType
  .width(200)
  .innerRadius(20)
  .dimension(lapTypeDim)
  .group(lapTypeDim.group().reduceCount())
  .valueAccessor(function(d) { return d.value; });

chartPointsCount
  .group(facts.groupAll().reduce(function(p) {
      return p + 1;
    }, function(p) {
      return p - 1;
    }, function() {
      return 0;
    }))
  .formatNumber(d3.round)
  .valueAccessor(function(d) { return d; });
  
chartTotalDistance
  .group(facts.groupAll().reduceSum(function(d) { return d.DistancePoint; }))
  .formatNumber(function(d) {
    return d3.round(d / 1000,2) + " km";
  })
  .valueAccessor(function(d) { return d; });
  
chartTotalTime
  .group(facts.groupAll().reduceSum(function(d) { return d.TimePoint; }))
  .formatNumber(function(d) {
    return formatSeconds(d3.round(d / 1000));
  })
  .valueAccessor(function(d) { return d; });

chartMovingTime
  .group(facts.groupAll().reduceSum(function(d) { 


return d.LapType == "Stationary" ? 0 : d.TimePoint; }))
  .formatNumber(function(d) {
    return formatSeconds(d3.round(d / 1000));
  })
  .valueAccessor(function(d) { return d; });

dc.renderAll();
refreshDataTable();

d3.csv('/activities.csv', function(activities) {
  dc.redrawAll();
  refreshDataTable();
  
  activities.forEach(function(a,i) {
    
    // length represents the type of workout, in minutes
    var lenRegex = /^([0-9]+)\-([0-9]+)\-([0-9]+)$/g;
    var lenMatch = lenRegex.exec(a.Length);
    if (lenMatch != null) {
      var start = 0;
      var lenWarmup = +lenMatch[1]*60*1000;
      var lenWorkout = +lenMatch[2]*60*1000;
      var lenCooldown = +lenMatch[3]*60*1000;
      
      var warmupEnd = start + lenWarmup;
      var workoutEnd = warmupEnd + lenWorkout;
      var cooldownEnd = workoutEnd + lenCooldown;
      
      a.Length = {
        Warmup: [0, warmupEnd], 
        Workout: [warmupEnd, workoutEnd], 
        CoolDown: [workoutEnd,cooldownEnd]};
    } else if (/^[0-9]+$/) {
      a.Length = {Workout: [0,+a.Length*60*1000]};
    } else {
      console.log("Activity has invalid length " + a.Length,a);
    }
    
    d3.csv('/activities/'+a.File, function(d,i) {
      
      d.File = a.File;
      d.Lap = +d.Lap;
      d.Distance = +d.Distance;
      d.Time = timeParser.parse(d.Time);
      d.HeartRate = +d['Heart Rate'];
      delete d['Heart Rate'];
      
      return d;
    }, function(data) {
      console.log('activity',a,data);
      
      var lengthKeys = d3.keys(a.Length);
      
      var elapsedTime = 0;
      var movingTime = 0;
      data.forEach(function(d,i) {
        d.Activity = a.Name;
        d.ActivityLength = a.Length;
        d.DistancePoint = i == 0 ? d.Distance : d.Distance - data[i-1].Distance;
        d.TimePoint = i == 0 ? 1000 : d.Time - data[i-1].Time;
        
        elapsedTime += d.TimePoint;
        d.TimeElapsed = elapsedTime;
        
        if (d.DistancePoint < 0.37) {
          d.LapType = "Stationary";
          d.TimeMoving = movingTime;
        } else {
          movingTime += d.TimePoint;
          d.TimeMoving = movingTime;

        if (lengthKeys.length == 1) {
          d.LapType = lengthKeys[0];
        } else if (lengthKeys.length == 3) {
          lengthKeys.forEach(function(k) {
            if (d.TimeMoving >= a.Length[k][0] &&
                d.TimeMoving <= a.Length[k][1]) {
              d.LapType = k;
            }
          });
          if (!d.LapType) {
            d.LapType = "Unknown";
          }
        } else {
          d.LapType = "Unknown";
        }
}
      });
      
      facts.add(data);
      dc.redrawAll();
      refreshDataTable();
    });
  });
  
  
});

  
} catch (e) {
  console.log("ERROR",e);
  alert(e.message);
}
    </script>
  </body>
</html>
