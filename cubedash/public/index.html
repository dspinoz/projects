<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>Cubedash</title>
    <script src="/d3.js"></script>
    <script src="/queue.js"></script>
    <script src='/jquery.js' type='text/javascript'></script>
    <script src='/bootstrap.js' type='text/javascript'></script>
    <link href='/bootstrap.css' rel='stylesheet' type='text/css'>
    <style type="text/css">
    </style> 
  </head>
  
  <body>
    
    <!-- Static navbar -->
    <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Cubedash</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Event Types</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    
    <div class='container' style='font: 12px sans-serif;'>
      <div class='row'>
        <div class='span12'>
          <table class='table table-hover' id='event-types'>
            <thead>
              <tr class='header'>
                <th>Type</th><th>10-sec</th><th>1-min</th><th>5-min</th><th>1-hr</th><th>1-day</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
    
    <script type='text/javascript'>
      
      var data = [];
      
      var steps = [
        {name: '10-sec', step: '1e4'},
        {name: '1-min', step: '6e4'}, 
        {name: '5-min', step: '3e5'},
        {name: '1-hr', step: '36e5'},
        {name: '1-day', step: '864e5'}
      ];
      
      // easy lookup for sort
      var stepIndexes = {};
      steps.forEach(function(s,i) {
        stepIndexes[s.name] = i;
      });
          
      function stepFunc(info, callback) {
        d3.json("/metric?expression=sum("+info.n+")&step="+info.v.step+"&limit=1", 
                function (err, json) {
                  // bind the data ourself
                  data.push({ type: info.n, step: info.v.name, value: json[0] });
                  callback(err, null);
                });
      }
      
      function typeFunc(info, callback) {
        var path = info.path;
        
        d3.json(path, function(err, json) {
          // bind the data outself
          json.forEach(function(t) {
            
            steps.forEach(function (s) {
              info.q.defer(stepFunc, {n: t, v: s});
            });
            
          });
          callback(err,null);
        });
      }
      
      function renderData(err)
      {
        var groups = d3.nest()
                      .key(function (d) {
                        return d.type;
                      })
                      .key(function (d) {
                        return d.step;
                      })
                      .entries(data);
              
        var table = d3.select('#event-types');
        var body = table.append('tbody');
        var items = body.selectAll('tr')
                      .data(groups);
                      
             
        items.attr('class', 'update')
          .text(function (d) {
            console.log('update');
            console.log(d);
            return d;
          });
                  
        var tr = items
          .enter()
          .append('tr')
          .attr('id', function(d,i) {
            return i;
          });
                  
        var td = tr.selectAll('td')
          .data(function(d) {
            
            d.values.sort(function (a,b) {
              return stepIndexes[a.key] - stepIndexes[b.key];
            });
            
            d.values.unshift({key: d.key});
            return d.values;
          });
          
          td.attr('class', 'update')
          .text(function(d) {
            console.log('update td');
            console.log(d);
            return d;
          });
          
          td.enter()
          .append('td')
          .text(function(d,i) {
            if (d.values == undefined)
            {
              return d.key;
            }
            
            return d.values[0].value.value;
          });
        
        console.log("render done");
      }
      
      // perform synchronous requests to build up all the data
      
      var waiter = queue();
      waiter.defer(typeFunc, {path: "/types", q: waiter})
        .await(function (err) {
          renderData(err);
        });
      
      
      setInterval(function () {
        
        data = [];
        waiter = queue();
        waiter.defer(typeFunc, {path: "/types", q: waiter})
          .await(renderData);
        
      }, 200000);
      
    </script>
  </body>
</html>
