<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>Cubedash</title>
    <script src="/d3.js"></script>
    <script src='/jquery.js' type='text/javascript'></script>
    <script src='/bootstrap.js' type='text/javascript'></script>
    <link href='/bootstrap.css' rel='stylesheet' type='text/css'>
    <style type="text/css">
    </style> 
  </head>
  
  <body>
    
    <!-- Static navbar -->
    <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Cubedash</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Event Types</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    
    <div class='container' style='font: 12px sans-serif;'>
      <div class='row'>
        <div class='span12'>
          <table class='table table-hover' id='event-types'>
            <thead>
              <tr class='header'>
                <th>Type</th><th>Sum</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
    
    <script type='text/javascript'>
      
      d3.json("/types", function(types) {
        console.log(types);
        
        var data = [];
        
        var step = "6e4"; //last 5 minutes
        var table = d3.select('#event-types');
        var body = table.append('tbody');
        
        types.forEach(function (t) {
          var query = "/metric?expression=sum("+t+")&step="+step+"&limit=1";
        
          d3.json(query, function(hr) {
            
            data.push({ name: t, last_hr: hr[0].value });
            
            var rows = body.selectAll('tr');
            
            var row = rows.data(data)
                         .enter()
                         .append('tr');
            
            row.append('td')
            .text(function(d) {
              return d.name;
            });
            
            row.append('td')
            .text(function(d) {
              return d.last_hr;
            });
            
          });
        });
        
      });
    </script>
  </body>
</html>
