<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>Cubedash</title>
    <script src="/d3.js"></script>
    <script src="/queue.js"></script>
    <script src='/jquery.js' type='text/javascript'></script>
    <script src='/bootstrap.js' type='text/javascript'></script>
    <link href='/bootstrap.css' rel='stylesheet' type='text/css'>
    <style type="text/css">
    </style> 
  </head>
  
  <body>
    
    <!-- Static navbar -->
    <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Cubedash</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Event Types</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    
    <div class='container' style='font: 12px sans-serif;'>
      <div class='row'>
        <div class='span12'>
          <table class='table table-hover' id='event-types'>
            <thead>
              <tr>
                <th>Type</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>

          <button type="button" class="btn btn-default btn-lg" onclick="updateData()">
            <span class="glyphicon glyphicon-repeat"></span> Update
          </button>
          
          <table class='table table-hover' id="test">
          
          </table>
        </div>
      </div>
    </div>
    
    <script type='text/javascript'>
      
      var steps = [
        {name: '10-sec', step: '1e4'},
        {name: '1-min', step: '6e4'}, 
        {name: '5-min', step: '3e5'},
        {name: '1-hr', step: '36e5'},
        {name: '1-day', step: '864e5'}
      ];
      
      // easy lookup for sort
      var stepIndexes = {};
      steps.forEach(function(s,i) {
        stepIndexes[s.name] = i;
      });
      
      
      function updateButton() {
        
        d3.json("/test", function(json) {
          
          var p = d3.select("#test").selectAll('p')
                    .data(json);
                    
          p.text(function(d) {
            return d;
          });
                    
          p.enter().append('p').text(function (d) {
            return d;
          });
                    
          p.exit().remove();
          
          console.log(json);
        });
      }
      
      var th = d3.select('#event-types thead tr')
                .selectAll('th.step')
                .data(steps);
                
      th.text(function (d) {
        return d.name;
      });
      
      th.enter()
        .append('th')
        .attr('class', 'step')
        .text(function(d) {
          return d.name;
        });
        
      th.exit().remove();
      
      function updateData() {
        
        d3.json("/types", function(json) {
          
          var tr = d3.select('#event-types tbody')
                    .selectAll('tr')
                    .data(json);
                    
          tr.text(function (d) {
            return d;
          });
            
          tr.enter() 
            .append('tr')
            .attr('id', function (d) {
              return d;
            })
            // gets deleted on second update!
            .append('td')
            .attr('class','type')
            .text(function (d) {
              return d;
            });
            
          tr.exit().remove();
          
          function getSum(info, callback)
          {
            d3.json('/metric?expression=sum('+info.type+')&step='+info.step.step+'&limit=1', function(metric) {
              
              console.log(info.type + " " + info.step.name + " " + metric[0].value);
              info.data[info.step.name] = metric;
              callback(null,null);
            });
          }
          
          
          json.forEach(function(t) {
            
            var q = queue();
            var typed = {type: t, steps: {} };
            
            steps.forEach(function(s) {

              q.defer(getSum, {type: t, step: s, data: typed.steps});
            });
            
            q.await(function() {
              
              typed.stepssorted = d3.entries(typed.steps);
              
              typed.stepssorted.sort(function(a,b) {
                return stepIndexes[a.key] - stepIndexes[b.key];
              });
              
              var td = d3.select('#event-types tbody tr#'+typed.type)
                        .selectAll('td.step') //force start with character
                        .data(typed.stepssorted);
              
              td.text(function(d) {
                return d.value;
              });
              
              td.enter()
                .append('td')
                .attr('class', 'step')
                .attr('id', function(d) {
                  return 'step'+d.key;
                })
                .text(function (d) {
                  return d.value[0].value;
                });
                
              td.exit().remove();
              
              
              
              
            });
            
          });
          
        });
      }
      
    </script>
  </body>
</html>
