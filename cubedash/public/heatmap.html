<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>Cubedash</title>
    <script src="/d3.js"></script>
    <script src="/queue.js"></script>
    <script src='/jquery.js' type='text/javascript'></script>
    <script src='/bootstrap.js' type='text/javascript'></script>
    <link href='/bootstrap.css' rel='stylesheet' type='text/css'>
    <style type="text/css">
      
      rect.bordered {
        stroke: #E6E6E6;
        stroke-width:2px;   
      }
      
    </style> 
  </head>
  
  <body>
    
    <!-- Static navbar -->
    <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Cubedash</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/index.html">Event Types</a></li>
            <li class="active"><a href="/heatmap.html">Heat Map</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    
    <div class='container' style='font: 12px sans-serif;'>
      <div class='row'>
        <div class='span12'>
          <div id='heatmap'>
          </div>
        </div>
      </div>
    </div>
    
    <script type='text/javascript'>
      
      var margin = { top: 50, right: 0, bottom: 100, left: 30 },
          width = 960 - margin.left - margin.right,
          height = 430 - margin.top - margin.bottom,
          gridSize = Math.floor(width / 24),
          legendElementWidth = gridSize*2,
          buckets = 9,
          colors = ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"], // alternatively colorbrewer.YlGnBu[9]
          days = ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"],
          times = ["1a", "2a", "3a", "4a", "5a", "6a", "7a", "8a", "9a", "10a", "11a", "12a", "1p", "2p", "3p", "4p", "5p", "6p", "7p", "8p", "9p", "10p", "11p", "12p"];

      var dayNumFormat = d3.time.format('%w');
      var dayFormat = d3.time.format('%a');
      var hrFormat = d3.time.format('%I%p');
      var hourFormat = d3.time.format('%H');
      var titleFormat = d3.time.format('%A %d at %H %p');


      var svg = d3.select("#heatmap").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


      d3.json('/metric?expression=sum(cube_request)&step=36e5&limit=168', function (data) {
        console.log('done');
        console.log(data);
        
        
        
        var days = d3.map(),
            times = d3.map(),
            daysLeft = 6,
            hoursLeft = 23;
        
        data.forEach(function(d) {
          d.time = d3.time.format.iso.parse(d.time);
          d.day = +dayNumFormat(d.time);
          d.hour = +hourFormat(d.time);
          
          if (!days.has(dayFormat(d.time)))
          {
            days.set(dayFormat(d.time), (daysLeft) - days.size());
          }
          
          if (!times.has(hrFormat(d.time)))
          {
            times.set(hrFormat(d.time), +hourFormat(d.time)); //in time order
            //(hoursLeft) - times.size()); //from data
          }
        });
        
        console.log('before');
        console.log(data);
        
        //how long from now until the end of the day?
        var left = 24 - hourFormat(data[0].time);
        console.log('HAS LEFT ' + left);
        
        
        console.log('after');
        console.log(data);
        
        for(var i =0; i < left; i++)
        {
          var rem = data.splice(0,1);
          console.log('removed ' + rem[0].day + ' ' + rem[0].hour + ' ' + rem[0].value + ' - ' + rem[0].time);
        }
        
        console.log('first ' + data[0].day + ' ' + data[0].hour + ' ' + data[0].value + ' - ' + data[0].time);
     
        
        
        
      var dayLabels = svg.selectAll(".dayLabel")
        .data(days.keys().reverse()) 
        .enter().append("text")
          .text(function (d) { return d; })
          .attr("x", 0)
          .attr("y", function (d, i) { return i * gridSize; })
          .style("text-anchor", "end")
          .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
          .attr("class", function (d, i) {
            
            if (i >= 0 && i <= 4) {
              return d+ " dayLabel mono axis axis-workweek";
            }
            
            return d+ " dayLabel mono axis";
          });

      var timeLabels = svg.selectAll(".timeLabel")
        .data(times.keys().reverse())
        .enter().append("text")
          .text(function(d) { return d; })
          .attr("x", function(d, i) { return times.get(d) * gridSize; })
          .attr("y", 0)
          .style("text-anchor", "middle")
          .attr("transform", "translate(" + gridSize / 2 + ", -6)")
          .attr("class", function(d, i) { return ((i >= 7 && i <= 16) ? "timeLabel mono axis axis-worktime" : "timeLabel mono axis"); });

        
        
      
        var colorScale = d3.scale.quantile()
          .domain([0, buckets - 1, d3.max(data, function (d) { return d.value; })])
          .range(colors);
        
        
        var heatMap = svg.selectAll(".hour")
          .data(data)
          .enter().append("rect")
            .attr("x", function(d,i) { return times.get(hrFormat(d.time)) * gridSize; })
            .attr("y", function(d,i) { return days.get(dayFormat(d.time)) * gridSize; })
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("class", function(d) {
              return dayFormat(d.time) + " hour bordered";
            })
            .attr("width", gridSize)
            .attr("height", gridSize)
            .style("fill", colors[0]);
            
          heatMap.transition().duration(1000)
            .style("fill", function(d,i) {
              /*if (i==0)
              {
                return 'red';
              }*/
              return colorScale(d.value); 
            });
            
          heatMap.append("title").text(function(d) { 
            return dayFormat(d.time) + ' ' + hrFormat(d.time) + ' (' + titleFormat(d.time) + ')'; 
          });
          
          
          
          
          var legend = svg.selectAll(".legend")
            .data([0].concat(colorScale.quantiles()), function(d) { return d; })
            .enter().append("g")
              .attr("class", "legend");

          legend.append("rect")
            .attr("x", function(d, i) { return legendElementWidth * i; })
            .attr("y", height)
            .attr("width", legendElementWidth)
            .attr("height", gridSize / 2)
            .style("fill", function(d, i) { return colors[i]; });

          legend.append("text")
            .attr("class", "mono")
            .text(function(d) { return "â‰¥ " + Math.round(d); })
            .attr("x", function(d, i) { return legendElementWidth * i; })
            .attr("y", height + gridSize);
          
        
      });
      
      
    </script>
  </body>
</html>
